---
title: "Chapter 7 - LME analysis of lh_slope ~ Mode and Nuclear pitch accents: "
author: "Antoin Rodgers"
date: "5.6.2022"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      warning=FALSE,
                      message=FALSE)

# Load Functions.
source("../../functions/myFunctions.R") 

# Load packages.
installMissingPackages(
  c(
    # Include statistical packages.
    "performance",
    "lmerTest",
    "lme4",
    "optimx",
    "MuMIn",
    # Include packages for tidy output.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",
    "RColorBrewer",
    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)

```

```{r load corpus, include=FALSE}
l_star_h_types = c("L*H", "^[L*]H", "L*^[H]", "^[L*H]")

# Load Corpus
m_corpus <- get_m_corpus("../data/m_corpus.csv")  %>%
  # Select only columns for analysis
  select(
    speaker,
    gender,
    mode,
    prompt,
    acc_phon,
    fin_phon,
    lh_slope) %>% 
  filter(acc_phon %in% l_star_h_types)  %>% 
  mutate(acc_phon = factor(acc_phon,
                           levels = l_star_h_types)
         )
```


```{r run initial model,  fig.height=3, fig.width=9, eval=FALSE, tidy = TRUE}
# run model
lh_slope_model <-
    lmer(lh_slope ~ mode + acc_phon + (1 + mode + acc_phon | speaker) + (1 | gender) + (1 | fin_phon) + (1 | prompt),
        data = m_corpus,
        control = lmerControl(
            optimizer = "optimx",
            calc.derivs = FALSE,
            optCtrl = list(
                method = "nlminb",
                starttests = FALSE,
                kkt = FALSE
            )
        )
      )

summariseLME(lh_slope_model, run_step=TRUE)
```

-   Singularity and convergence  issues.
-   Testing reduced model suggested by step()

```{r run reduced step only model, fig.height=3, fig.width=9, eval=FALSE, tidy = TRUE}

lh_slope_model <- lmer(
  lh_slope ~ mode + acc_phon + (1 + mode + acc_phon | speaker) + (1 | prompt),
  data = m_corpus,
  control = lmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(lh_slope_model , run_step = TRUE)

```

-   Singularity and convergence issues persist.
-   Trying model without random acc_phon slope.
-   Model only works when gender removed as a random slope
-   Trimming model for observations with model residual of > 3 standard deviations.

#### `lh_slope ~ mode + acc_phon + (1 + mode | speaker) + (1 | gender) + (1 | fin_phon) + (1 | prompt`
```{r fewer random slopes model, fig.height=3, fig.width=9, include=FALSE}
lh_slope_model <- lmer(
  lh_slope ~ mode + acc_phon +
    (1 + mode | speaker) +  (1 | fin_phon) + (1 | prompt),
        data = m_corpus,
        control = lmerControl(
            optimizer = "optimx",
            calc.derivs = FALSE,
            optCtrl = list(
                method = "nlminb",
                starttests = FALSE,
                kkt = FALSE
            )
        )
      )
summariseLME(lh_slope_model , run_step = TRUE)
```


```{r trimmed model tested, fig.height=3, fig.width=9, tidy = TRUE}
m_corpus.trimmed <- m_corpus %>% filter(abs(scale(resid(lh_slope_model))) <= 3)

lh_slope_model.trimmed <- lmer(
  lh_slope ~ mode + acc_phon +
    (1 + mode | speaker) +  (1 | fin_phon) + (1 | prompt),
        data = m_corpus.trimmed,
        control = lmerControl(
            optimizer = "optimx",
            calc.derivs = FALSE,
            optCtrl = list(
                method = "nlminb",
                starttests = FALSE,
                kkt = FALSE
            )
        )
    )

summariseLME(lh_slope_model.trimmed, run_step = TRUE,
              write="../output_model_anovas/Mode_PA_lh_slope_anova.csv")
```

```{r make tidy model, fig.height=2.5, fig.width=5, results="asis"}

lh_slope_model.tidy <- analyseModel(lh_slope_model.trimmed,
                                write="../output/Mode_PA_lh_slope"
                                )
lh_slope_model.tidy$table

```

```{r do pairwise analysis}

charts <- getModelFixedFX(
  my_equation = lh_slope ~ mode + acc_phon +
    (1 + mode | speaker) +  (1 | fin_phon) + (1 | prompt),
  my_data = m_corpus.trimmed,
  write="../output/Mode_PA_lh_slope"
)

charts$slopes


```
