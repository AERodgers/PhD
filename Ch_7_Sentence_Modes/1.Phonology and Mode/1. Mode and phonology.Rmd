---
title: 'Chapter 07: Analysis of Function: Sentence Modes and Phonology (Register Tier)'
mainfont: Times New Roman
output:
  html_document: default
font-family: Times New Roman
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)


# Load Functions.
source("../../functions/myFunctions.R") 

# Load packages.
installMissingPackages(
  c(
    "lmerTest",
    "lme4",
    "optimx",
    "MuMIn",
    "tidyverse",
    "formattable",
    "janitor",
    "knitr",
    "RColorBrewer",
    "broom",
    "broomExtra"
  )
)

# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 18))

# Change this as required
options("speakr.praat.path" = "C:/Program Files/Praat/Praat.exe")

## set colours

mode_colours <- c("MDC" = brewer.pal(4, "Dark2")[3],
                  "MWH" = brewer.pal(4, "Dark2")[2],
                  "MYN" = brewer.pal(4, "Dark2")[1],
                  "MDQ" = brewer.pal(4, "Dark2")[4])
p_color <- all_models_tidy ~ style(color =
                                     if_else(as.double(all_models_tidy) < 0.05,
                                             "green",
                                             "red")
                                   )
pitch_accent_colours <- c("H*"     = brewer.pal(6, "Set2")[5],
                          "L*H"    = brewer.pal(6, "Set2")[3],
                          "^[L*]H" = brewer.pal(6, "Set2")[6],
                          ">H*"    = brewer.pal(6, "Set2")[4],
                          "L*^[H]" = brewer.pal(6, "Set2")[2],
                          "^[L*H]" = brewer.pal(6, "Set2")[1])
```

```{r load and process corpus, include=FALSE}
m_corpus <- get_m_corpus("../data/m_corpus.csv")  %>%
  # Consolidate nuc_contour based on observation and types of register shift.

  mutate(
    nuc_contour =
      if_else(
        nuc_contour == "^[L*H %]" | nuc_contour == "^[L*H L%]",
        "^[L*H] %",
        if_else(nuc_contour == "L*^[H L%]", "L*^[H] %", nuc_contour)
      ),
    acc_phon = factor(str_replace(nuc_contour, "\\s%$|\\sL%$", ""),
                      levels = c("H*", "L*H", "^[L*]H", ">H*", "L*^[H]", "^[L*H]")),
    acc_phon = factor(acc_phon, levels = unique(acc_phon)
      ),
    # remove non-accentuation from phr_phon
   
    phr_phon = str_replace_all(phr_phon, "\\(\\*\\)\\s", ""),
    phr_phon = str_replace_all(phr_phon, "\\s\\s", "\\s"),
    phr_phon = factor(phr_phon, levels=unique(phr_phon)),
    one_star = str_count(phr_phon, "\\*")==1,
    one_star = factor(one_star, levels=unique(one_star)),
    h_reg = str_detect(phr_phon, "\\^"),
    h_reg =  factor(h_reg, levels=unique(h_reg)),
    mode =  factor(mode, levels=unique(mode))
    
    ) %>%

  # Select only columns for analysis
  select(speaker,
         gender,
         mode,
         prompt,
         stim,
         phr_phon,
         acc_phon,
         nuc_contour,
         one_star,
         h_reg)


```


* models with random slopes generate singularity issues.
```{r fig.height=3, fig.width=9, warning = FALSE, message = FALSE, tidy = TRUE}
m_corpus_no_MWH <- m_corpus %>%
    filter(mode %notin% c("MWH")) %>%
    mutate(mode = factor(mode, levels = c("MDC", "MYN", "MDQ")))

utt_phon_model <- glmer(
  mode ~ one_star + h_reg + (1 | speaker),
  data = m_corpus_no_MWH,
  family = binomial(link = "logit"),
  # change optimizer to avoid convergence errors
  control = glmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

utt_phon_model_null = 
  cur_model <- glmer(
  mode ~ 1 + (1 | speaker),
  data = m_corpus_no_MWH,
  family = binomial(link = "logit"),
  # change optimizer to avoid convergence errors
  control = glmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summary(utt_phon_model) 

cat(
  "isSingular(utt_phon_model, tol=1e-5) -->",
  isSingular(utt_phon_model, tol = 1e-5),
  "\n"
)

anova(utt_phon_model, utt_phon_model_null, test="Chisq") %>%
  formattable(
  caption="ANOVA of model and null model, assuming presence of register tier"
  )


x <- printTidyModel(utt_phon_model,
                    write_r2="utt_mode_GLMM",
                    is_GLM = TRUE)



x$r2
x$table


```



## Intercepts and Pairwise comparisons
```{r echo=FALSE, paged.print=FALSE}

charts <- getModelFixedFX(
  my_equation = mode ~ one_star + h_reg + (1 | speaker),
  my_data = m_corpus_no_MWH,
  write="utt_mode_GLMM",
  is_GLM=TRUE,
  extra_text = ", assuming presence of register tier"
)


charts$intercepts
charts$pairwise
```
