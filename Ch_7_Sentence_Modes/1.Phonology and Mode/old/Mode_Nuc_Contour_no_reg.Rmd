---
title: 'Chapter 07: Analysis of Function: Sentence Modes and Nuclear Contours - No register'
output:
  html_document: default
  word_document: default
---


```{r setup, warning=TRUE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

# Load Functions.
source("../../functions/myFunctions.R") 

# Load packages.
installMissingPackages(
  c(
    # Include statistical packages.
    "performance",
    "lmerTest",
    "lme4",
    "optimx",
    "MuMIn",
    
    # Tidyverse and visualisation packages.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",
    #"speakr",
    #"ggpubr",
    "RColorBrewer",
    #"tidymodels",
    # Packages for %in% / %notin% syntactic notation
    "mefa4"
  )
)


# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 14))

# Change this as required
options("speakr.praat.path" = "C:/Program Files/Praat/Praat.exe")

## set colours
mode_colours <- c("WHQ" = "#e66101",
                  "MDC" = "#5e3c99",
                  "MYN" = "#fdb863",
                  "MDQ" = "#b2abd2")

p_color <- all_models_tidy ~ style(
  color =if_else(as.double(all_models_tidy) < 0.05,
                                             "green",
                                             "red")
                                   )
pitch_accent_colours <- c("H* L%"     = brewer.pal(8, "Set2")[5],
                          "L*H %"    = brewer.pal(8, "Set2")[3],
                          "L*H L%" = brewer.pal(8, "Set2")[7],
                          ">H* L%"    = brewer.pal(8, "Set2")[4])

# Get  Data.
m_corpus <- get_m_corpus("../data/m_corpus.csv")  %>%
  # Consolidate nuc_contour based on observation and types of register shift.
  mutate(
    nuc_contour = factor(str_replace_all(nuc_contour, "\\^|\\[|\\]", ""),
                         levels = unique(nuc_contour)),
    acc_phon = factor(str_replace_all(acc_phon, "\\^|\\[|\\]", ""),
                      levels = unique(acc_phon)),
    fin_phon = factor(str_replace_all(fin_phon, "]", ""),
                      levels = unique(fin_phon))
  ) %>%
  # Select only columns for analysis
  select(speaker,
         gender,
         mode,
         prompt,
         stim,
         nuc_contour)

```

## **__Raw Data__**

```{r warning=FALSE}

# Calculate the number of tokens of each PA as a function of sentence mode.
#
# These are mode_tokens_adjusted raw values and can over- or under-represent
# sentence modes and speakers.

modes_nuc_summaries <- m_corpus %>%
  group_by(mode, nuc_contour) %>%
  summarise(nuc_count = n()) %>%
  spread(nuc_contour, nuc_count, is.na <- 0) %>% 
  # Save the results in a csv file
  write_csv("../output/modes_nuc_contour_raw_no_reg.csv")
```

### Nuclear Contour by speaker

```{r warning=FALSE}
# Create summary table of Contour by Speaker.

m_corpus %>%
  group_by(speaker, nuc_contour) %>%
  summarise(nuc_count = n(), .groups="keep") %>%
  spread(nuc_contour, nuc_count, is.na <- 0) %>%
  write_csv("../output/nuc_contour_by_speaker_raw_no_reg.csv") %>%
  rename ("\\>H* L%" = ">H* L%") %>% 
  formattable()
```


### Nuclear Contour by Sentence Mode

```{r warning=FALSE}
# Create summary table of Contour by Sentence Mode.

modes_nuc_summaries %>% formattable()

```


#### Chi Squared test of association using raw data

```{r}

with(m_corpus, table(mode, nuc_contour)) %>% chisq.test %>% print()

```

## **__Adjusted Data__**

The raw data is unbalanced since there number of utterances per target speaker varies slightly. For some speakers, there are no repetitions of some target utterances. Therefore, the data has been adjusted to project an estimated balanced number of tokens per speaker per target utterance.

This is done in three stages, using the local function `balancedData()`:
    1. The function calculates the ratio of each token per target per speaker. This is multiplies by a constant reflecting the target number of token for that utterance.
    2. It then calculates the total number of tokens per target as a proportion of the actual number of speakers for each target. Again, this is multiplied by a constant to reflect the ideal target number of speakers per target.
    3. The resulting values are rounded to an integer to approximate the projected ideal number of total tokens per speaker per utterance.


### Nuclear Contour by Speaker

```{r warning=FALSE}
pa_by_speaker_pc <- m_corpus %>%
    mutate(nuc_contour = factor(nuc_contour, levels = unique(nuc_contour))) %>% 
    group_by(speaker, nuc_contour) %>%
    summarise(nuc_count = n(), .groups = "keep") %>%
    spread(nuc_contour, nuc_count, is.na <- 0, drop = FALSE) %>%
    mutate(tot_PAs = sum(c_across())) %>%
    mutate(across(1:last_col(), ~ round(. / tot_PAs * 60))) %>%
    select(-tot_PAs)

pa_by_speaker_pc %>%
    write_csv("../output/nuc_contour_by_speaker_adj_no_reg.csv")  %>%
    rename_all(list(~str_replace_all(., "([\\*\\[\\^\\>])", "\\\\\\1"))) %>% 
    formattable()

pa_by_speaker_pc_uncount <- pa_by_speaker_pc %>%
    gather("nuc_contour", "count",-c(speaker)) %>%
    uncount(count) %>%
    mutate(nuc_contour = factor(
        nuc_contour,
        levels = unique(nuc_contour)))


```


```{r warning=TRUE, fig.width = 10, fig.height = 4}
# Percentage Stacked bar

ggplot(data = pa_by_speaker_pc_uncount,
       aes(fill = nuc_contour, x = speaker)) +
    geom_bar(
        stat = "count",
        position = "fill",
        width = 0.30,
        colour = "black"
    ) +
    scale_fill_manual(values = pitch_accent_colours) +
    
    labs(y = "Proportion of Contours (no register)",
         x = "Speaker") +
    theme(panel.border = element_rect(fill = NA)) +
    scale_y_continuous(sec.axis = sec_axis( ~ . * 3 + 4))
```

### Nuclear Contour by Sentence Mode

```{r warning=FALSE}
# Calculate a projected balanced number of tokens for each PA as a function of # sentence mode.
#
# This takes into consideration the number of utterances per speaker per stimulus and the number of speakers per stimulus.

balancedData(m_corpus,
             stim, nuc_contour,
             "",
             11,
             5,
             use_pa_hierarchy = FALSE) %>%
    rename(mode = stim) %>%
    mutate(mode = substr(mode, 1, 3)) %>% group_by(mode) %>%
    pivot_longer(2:last_col(), "nuc_contour") %>%
    mutate(nuc_contour = factor(
        nuc_contour,
                levels = unique(nuc_contour)
    ),
    mode = factor(mode, levels = c("MDC", "MWH", "MYN", "MDQ"))) %>%
    group_by(nuc_contour, mode) %>%
    summarise(acc_count = sum(value)) %>%
    spread(nuc_contour, acc_count, is.na <- 0) %>%
    write_csv("../output/modes_nuc_contour_balanced_no_reg.csv") %>%
    rename_all(list(~str_replace_all(., "([\\*\\[\\^\\>])", "\\\\\\1"))) %>%  
    formattable()

```

```{r warning=FALSE}

# Get list of projected PA tokens by mode and gender.
mode_tokens_adjusted <- rbind(
  # Get projected number of PA tokens for female speakers per stimulus.
  pivot_longer(
    # Get summary table of adjusted PAs per mode for female speakers.
    balancedData(
      data_set = m_corpus ,
      treatment_col = stim,
      response_col = nuc_contour,
      gender_filter = "F",
      num_speakers = 6,
      num_reps = 5,
      use_pa_hierarchy = FALSE
      ) %>%
      # Convert stim column to mode column.
      rename(mode = stim) %>%
      mutate(mode = substr(mode, 1, 3)) %>% group_by(mode),
    c(2:last_col()),
    names_to = "nuc_contour"
    ) %>%
    # Convert summary table for female speakers into a list of tokens.
    group_by(mode, nuc_contour) %>%
    uncount(value) %>%
    mutate(nuc_contour = factor(
      nuc_contour,
      levels = unique(nuc_contour)
      )) %>%
    # Add gender column
    mutate(gender = "F"),
  
  # Get projected number of PA tokens for male speakers per stimulus.
  pivot_longer(
    # Get summary table of PAs per mode of balanced data for male speakers.
    balancedData(
      data_set = m_corpus,
      treatment_col = stim,
      response_col = nuc_contour,
      gender_filter = "M",
      num_speakers = 5,
      num_reps = 5,
      use_pa_hierarchy = FALSE
      ) %>%
      # Convert stim column into mode column by removing last character in the
      # stim column string and renaming column  "mode".
      rename(mode = stim) %>%
      mutate(mode = substr(mode, 1, 3)) %>% group_by(mode),
    c(2:last_col()),
    names_to = "nuc_contour"
    ) %>%
    # Convert summary table for female speakers into a list of tokens.
    group_by(mode, nuc_contour) %>%
    uncount(value) %>%
    mutate(nuc_contour = factor(
      nuc_contour,
      levels = unique(nuc_contour)
    )) %>%
    # Add gender column
    mutate(gender = "M")
  ) %>%
  mutate(mode = factor(mode, levels = c("MDC", "MWH", "MYN", "MDQ")))


```

```{r, fig.height=7, fig.width=10, eval=FALSE}
ggplot(mode_tokens_adjusted) +
    geom_bar(
        mapping = aes(x = mode, fill = nuc_contour),
        colour = "black",
        show.legend = FALSE,
        position = position_dodge2(preserve = "single")
    ) +
    facet_grid(rows = vars(gender), cols = vars(nuc_contour)) +
    ggtitle("Nuclear contours by sentence mode (adjusted, no register)") +
    scale_fill_manual(values = pitch_accent_colours) +
    labs(x = "mode and gender",
         y = "tokens (n)") +
    theme(panel.border = element_rect(fill = NA))
```

Gives the impression that males are more likely to shift contour types across modes.

```{r fig.height=4, fig.width=10}
ggplot(mode_tokens_adjusted) +
    geom_bar(
        mapping = aes(x = mode, fill = nuc_contour),
        show.legend = FALSE,
        colour = "black",
        position = position_dodge2(preserve = "single")
    ) +
    facet_grid(cols = vars(nuc_contour)) +
    theme(
        panel.border = element_rect(fill = NA),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 16)
    ) +
    #ggtitle("PNs across foot size conditions (adjusted)") +
    scale_fill_manual(values = pitch_accent_colours, name = "Contour") +
    labs(x = "Mode", y = "tokens (n)") +
    theme(panel.border = element_rect(fill = NA))

```

#### Chi Squared test of association using adjusted data

```{r}

with(mode_tokens_adjusted,
     table(mode, nuc_contour)) %>% chisq.test %>% print()

```
Overall, mode appears to be somewhat related to theuse of L%.
