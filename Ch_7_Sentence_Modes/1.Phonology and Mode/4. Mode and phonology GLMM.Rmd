---
title: 'Chapter 07: Analysis of Function: Sentence Modes'
output:
  html_document: default
  word_document: default
  pdf_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)


# Load Functions.
source("../../functions/myFunctions.R") 

# Load packages.
installMissingPackages(
  c(
    # Include statistical packages.
    "lmerTest",
    "lme4",
    "optimx",
    "MuMIn",
    
    # Include packages for tidy output.
    "broomExtra",
    "formattable",
    "janitor",
    "knitr",
    "RColorBrewer",
    "sjPlot",
    "tidyverse",
    
    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)

# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 10))

```


```{r load and process corpus, include=FALSE}
# Get  Data.
m_corpus <- get_m_corpus("../data/m_corpus.csv")  %>%
  # Consolidate nuc_contour based on observation and types of register shift.
  mutate(
    nuc_contour =
      if_else(
        nuc_contour == "^[L*H %]" | nuc_contour == "^[L*H L%]",
        "^[L*H] %",
        if_else(nuc_contour == "L*^[H L%]", "L*^[H] %", nuc_contour)
      ),
    acc_phon = factor(str_replace(nuc_contour, "\\s%$|\\sL%$", ""),
                      levels = c("H*", "L*H", "^[L*]H", ">H*", "L*^[H]", "^[L*H]")),
    acc_phon = factor(acc_phon, levels = unique(acc_phon)
      )
  ) %>%
  # Select only columns for analysis
  select(speaker,
         gender,
         mode,
         acc_phon)


```

#### GLMM test of difference between acc_phon as a fn of mode.

* models with random slopes generate singularity issues.
```{r model test, tidy = TRUE}
acc_phon_model <- glmer(
  acc_phon ~ mode + (1 | speaker),
  data = m_corpus,
  family = binomial(link = "logit"),
  # change optimizer to avoid convergence errors
  control = glmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

acc_phon_model_null = 
  cur_model <- glmer(
  acc_phon ~ 1 + (1 | speaker),
  data = m_corpus,
  family = binomial(link = "logit"),
  # change optimizer to avoid convergence errors
  control = glmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summary(acc_phon_model)
```


```{r model results, fig.width = 4.2, fig.height = 2.5, results="asis"}
cat(
  "isSingular(acc_phon_model, tol=1e-5) -->",
  isSingular(acc_phon_model, tol = 1e-5),
  "\n"
)

anova(acc_phon_model, acc_phon_model_null, test="Chisq") %>%
  formattable(
  caption="ANOVA of model and null model, assuming presence of register tier"
  )

x <- printTidyModel(acc_phon_model,
                    write_r2="Mode_PA_GLMM",
                    is_GLM = TRUE,
                    transform="exp",
                    show.intercept=TRUE,
                    type="est",
                    axis.lim = c(0.01, 10000)
                    )
x$r2
x$table


```


## Intercepts and Pairwise comparisons
```{r intercepts and pairwise tables}

charts <- getModelFixedFX(
  my_equation = acc_phon ~ mode + (1 | speaker),
  my_data = m_corpus,
  write="Mode_PA_GLMM",
  is_GLM=TRUE,
  extra_text = ", assuming presence of register tier"
)


charts$intercepts
charts$pairwise
```
