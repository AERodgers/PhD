---
title: "Chapter 7 - LME analysis of lh_slope ~ Mode and Nuclear pitch accents: "
author: "Antoin Rodgers"
date: "5.6.2022"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      warning=FALSE,
                      message=FALSE)

# Load Functions.
source("../../functions/myFunctions.R") 

# Load packages.
installMissingPackages(
  c(
    # Include statistical packages.
    "performance",
    "lmerTest",
    "lme4",
    "optimx",
    "MuMIn",
    # Include packages for tidy output.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",
    "RColorBrewer",
    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)

# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 14))

```

The aims of this set of analyses is to see if, once we account for assumed speaker-motivated use of pitch accent, the apparent "paralinguistic" differences in scaling (and possibly time) of phonetic parametics disappear disappear.

Give the sparsity of \^[L\*]H (n=6), H\* (n=2) and \>H \*(n=5), and considering that they are limited to a single speaker, I wanted to exclude then from the analysis.

They should be analysed independently for M8 alone.

```{r load corpus}
l_star_h_types = c("L*H", "^[L*]H", "L*^[H]", "^[L*H]")

# Load Corpus
m_corpus <- get_m_corpus("../data/m_corpus.csv")  %>%
  # Consolidate nuc_contour based on observation and types of register shift.
  mutate(
    nuc_contour =
      if_else(
        nuc_contour == "^[L*H %]" | nuc_contour == "^[L*H L%]",
        "^[L*H] %",
        if_else(nuc_contour == "L*^[H L%]", "L*^[H] %", nuc_contour)
      ),
    acc_phon =
      factor(
        str_replace(nuc_contour,
                    "\\s%$|\\sL%$",
                    ""),
        levels = c("H*", "L*H", ">H*", "^[L*]H", "L*^[H]", "^[L*H]")
      ),
    fin_phon = str_replace_all(fin_phon, "L%]|%]", "%")
  ) %>%
  # Select only columns for analysis
  select(
    speaker,
    gender,
    mode,
    prompt,
    acc_phon,
    fin_phon,
    lh_slope) %>% 
  filter(acc_phon %in% l_star_h_types)  %>% 
  mutate(acc_phon = factor(acc_phon,
                           levels = l_star_h_types)
         )
```

As with other models, excluding gender.

```{r run initial model,  fig.height=3, fig.width=9, tidy = TRUE}

# run model
lh_slope_model <-
    lmer(
        lh_slope ~ mode*acc_phon + fin_phon +
            (1 + mode + acc_phon | speaker) + (1 | prompt),
        data = m_corpus,
        control = lmerControl(
            optimizer = "optimx",
            calc.derivs = FALSE,
            optCtrl = list(
                method = "nlminb",
                starttests = FALSE,
                kkt = FALSE
            )
        )
      )


summarise_lme(lh_slope_model, run_step=TRUE) %>% print()

```

-   Singularity issues.
-   Using intercepts only model.

#### `lh_slope ~ mode*acc_phon + fin_phon + (1 | speaker) + (1 | prompt)`

```{r run intercepts only model,  fig.height=3, fig.width=9, message = FALSE, tidy = TRUE}

lh_slope_model_reduced <-
    lmer(lh_slope ~ mode*acc_phon + fin_phon +
            (1 | speaker) + (1 | prompt),
        data = m_corpus,
        control = lmerControl(
            optimizer = "optimx",
            calc.derivs = FALSE,
            optCtrl = list(
                method = "nlminb",
                starttests = FALSE,
                kkt = FALSE
            )
        )
    )

summarise_lme(lh_slope_model_reduced , run_step = TRUE)

```

-   Model works but needs trimming, but step suggests no interactions now.
-   Not changing model, but trimming outliers.

```{r trimmed model tested,  fig.height=3, fig.width=9, message = FALSE, tidy = TRUE}
m_corpus.trimmed <- m_corpus %>% filter(abs(scale(resid(lh_slope_model_reduced))) <= 3)

lh_slope_model_trimmed <-
    lmer(lh_slope ~ mode*acc_phon + fin_phon +
            (1 | speaker) + (1 | prompt),
        data = m_corpus.trimmed,
        control = lmerControl(
            optimizer = "optimx",
            calc.derivs = FALSE,
            optCtrl = list(
                method = "nlminb",
                starttests = FALSE,
                kkt = FALSE
            )
        )
    )

summarise_lme(lh_slope_model_trimmed , run_step = FALSE)
```

```{r make tidy model, fig.height=3, fig.width=9, warning = FALSE, message = FALSE, tidy = TRUE}

lh_slope_model.tidy <- printTidyModel(lh_slope_model_trimmed,
                                bf_adj = 16,
                                exclude_terms = c("fin_phonL%", "genderM"),
                                write_r2="../output/Mode_PA_lh_slope"
                                )
lh_slope_model.tidy$table
lh_slope_model.tidy$r2

```

Results suggest that indeed, unreliable effect of interactions dur to high variance and ovlap with 0.
Dropping interaction from model.

### Final Model: `lh_slope ~ mode + acc_phon + fin_phon + (1 | speaker) + (1 | prompt)`

```{r simpler trimmed model,  fig.height=3, fig.width=9, message = FALSE, tidy = TRUE}
m_corpus.trimmed <- m_corpus %>% filter(abs(scale(resid(lh_slope_model_reduced))) <= 3)

lh_slope_model_trimmed <-
    lmer(lh_slope ~ mode + acc_phon + fin_phon +
            (1 | speaker) + (1 | prompt),
        data = m_corpus.trimmed,
        control = lmerControl(
            optimizer = "optimx",
            calc.derivs = FALSE,
            optCtrl = list(
                method = "nlminb",
                starttests = FALSE,
                kkt = FALSE
            )
        )
    )

summarise_lme(lh_slope_model_trimmed , run_step = FALSE)


lh_slope_model.tidy <- printTidyModel(lh_slope_model_trimmed,
                                bf_adj = 16,
                                exclude_terms = c("fin_phonL%", "genderM"),
                                write_r2="../output/Mode_PA_lh_slope"
                                )
lh_slope_model.tidy$table
lh_slope_model.tidy$r2
```

```{r do pairwise analysis, fig.height=3, fig.width=9, warning = FALSE, message = FALSE, tidy = TRUE}

charts <- getModelFixedFX(
  my_equation = lh_slope ~ mode + acc_phon + fin_phon +
            (1 | speaker) + (1 | prompt),
  my_data = m_corpus.trimmed,
  exclude_terms = c("gender", "fin_phon"),
  bf_adj = 16,
  write="../output/Mode_PA_lh_slope"
)
charts$intercepts
charts$pairwise


```
