---
title: "LME Analysis of PNs"
author: "Antoin Rodgers"
date: "18.05.2022"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# Get personal functions and install / load necessary packages.
source("../functions/myFunctions.R")

installMissingPackages(
  c(
    # Include statistical packages.
    "performance",
    "lmerTest",
    "lme4",
    "ggeffects",
    "optimx",
    "MuMIn",
    "dfoptim",

    # Include packages for tidy output.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",
    
    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)

# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 14))

# Get  data for analysis

source("Ch_06_0_get_AH_corpora.R")

h_star_type <-  c("L*H", ">H*", "H*")
l_star_type <-  c("L*H", "L*")

pn <- pn %>%
  select(speaker,
         gender,
         ana_syls,
         foot_syls,
         wrd_end_syl,
         ana_text,
         pn_new_word,
         acc_phon,
         speech_rate,
         ana_end_t,
         foot_dur,
         l_t,
         l_f0,
         h_t,
         h_f0,
         lh_slope,
         f0_exc) %>%
  mutate(
    foot_dur = foot_dur / 100,
    gender = factor(gender, levels = c("F", "M")),
    foot_syls = factor(foot_syls, levels = 1:4)
  )

pn_l_data <- pn %>% 
  filter(acc_phon %in% l_star_type) %>% 
  mutate(acc_phon = factor(acc_phon, levels = l_star_type)) %>% 
  select(-c(h_t, h_f0))
  
pn_h_data <- pn %>% 
  filter(acc_phon %in% h_star_type) %>% 
  mutate(acc_phon = factor(acc_phon, levels = h_star_type)) %>% 
  select(-c(l_t, l_f0))

rm(nuc, nuc_foot, pn_lex, pn_ana, pn_foot, corpus, nuc_pre)


```

```{r check levels in factors, results="asis", eval=FALSE}

cat("Tibble factors for pn_l_data\n")
for (i in colnames(pn_l_data))
{
  if (is.factor(pn_l_data[[eval(i)]]))
  {
    cat("\n", i, "  \tlevels = ", levels(pn_l_data[[i]]))
  }
  else
  {
    cat("\n", i)
    }
  
}

cat("\n\nTibble factors for pn_h_data\n")
for (i in colnames(pn_h_data))
{
  if (is.factor(pn_h_data[[eval(i)]]))
  {
    cat("\n", i, "  \tlevels = ", levels(pn_h_data[[i]]))
  }
    else
  {
    cat("\n", i)
    }
  
}


```

## L targets

### Analysis of L timing
- removing SR and foot_dur for parity with h_t model (and also singularity)
```{r set l_t equation}
l_t_equation = formula(
  l_t ~ acc_phon
  + ana_syls
  + foot_syls
  + wrd_end_syl
  + pn_new_word
  + gender
  + (1 | speaker)
  #+ (1 | speech_rate)
  + (1 | ana_text)
  + (1 | ana_end_t)
  #+ (1 | foot_dur)
  )

optimizer = "optimx"
```

- intercepts only model
- trim: +/- residual sd > 3
```{r run l_t models, fig.height=3, fig.width=9}
pn_l_t_mdl = lmer(
  l_t_equation,
  pn_l_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
pn_l_t.trimmed <-
  pn_l_data %>% filter(abs(scale(resid(pn_l_t_mdl))) <= 2.5)

pn_l_t_mdl.trimmed = lmer(
  l_t_equation,
  pn_l_t.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(pn_l_t_mdl.trimmed,
             run_step = TRUE,
             extra_text = "[prenuclear PA]",
             write = "pn_anovas/pn_l_t_anova.csv")
```

```{r plot l_t estimated effects, fig.height=3.5, fig.width=5}
plot_model(
  pn_l_t_mdl,
  type = "est",
  transform = NULL,
  show.values = T,
  vline = "Red"
 )
```

```{r l_t model summary, fig.height=2.5, fig.width=5, results="asis"}
# tidyPrediction(pn_l_t_mdl.trimmed, write = "predictions/pn_l_t_mdl")
pn_l_t_mdl.tidy <- analyseModel(pn_l_t_mdl.trimmed,
                                write="pn_phonetic_models/pn_l_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )
pn_l_t_mdl.tidy$table

```

```{r do l_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  l_t_equation,
  pn_l_t.trimmed,
  optimizer,
  write="pn_phonetic_models/pn_l_t"
)
charts$intercepts
charts$slopes


```



### Analysis of L F0

- Only intercepts only model avoided convergence and singularity issues
- Speech rate caused massive estimation issues
- Removing + wrd_end_syl as it has little effect
- removing ana_text to avoid error

```{r set l_f0 equation}
l_f0_equation = formula(
  l_f0 ~ acc_phon
  + ana_syls
  + foot_syls
  #+ wrd_end_syl
  + pn_new_word
  + (1 | speaker)
  #+ (1 | speech_rate)
  #+ (1 | ana_text)
  #+ (1 | ana_end_t)
  #+ (1 | foot_dur)
  )
optimizer = "optimx"
```

- model needs trimming (|sd| residuals > 3.5)
```{r run l_f0 models, fig.height=3, fig.width=9}
pn_l_f0_mdl = lmer(
  l_f0_equation,
  pn_l_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
pn_l_f0.trimmed <-
  pn_l_data %>% filter(abs(scale(resid(pn_l_f0_mdl))) <= 3.5)


pn_l_f0_mdl.trimmed = lmer(
  l_f0_equation,
  pn_l_f0.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)


summariseLME(pn_l_f0_mdl.trimmed,
             run_step = TRUE,
             extra_text = "[prenuclear PA]",
             write = "pn_anovas/pn_l_f0_anova.csv")
```


```{r plot l_f0 estimated effects, fig.height=3.5, fig.width=5}
plot_model(
  pn_l_f0_mdl.trimmed,
  type = "est",
  transform = NULL,
  show.values = T,
  vline = "Red"
 )
```


```{r l_f0 model summary, fig.height=2.5, fig.width=5, results="asis"}
# tidyPrediction(pn_l_f0_mdl.trimmed, write = "predictions/pn_l_f0_mdl")
pn_l_f0_mdl.tidy <- analyseModel(pn_l_f0_mdl.trimmed,
                                write="pn_phonetic_models/pn_l_f0",
                                type = "pred"
                                )
pn_l_f0_mdl.tidy$table

```

```{r do l_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  l_f0_equation,
  pn_l_f0.trimmed,
  optimizer,
  write="pn_phonetic_models/pn_l_f0"
)
charts$intercepts
charts$slopes

```

## H targets

### Analysis of H timing

- Only intercepts only model avoided convergence and singularity issues
- Random factors reduce 
```{r set h_t equation}
h_t_equation = formula(
  h_t ~ acc_phon
  + ana_syls
  + foot_syls
  + pn_new_word
  + wrd_end_syl
  + gender
  + (1 | speaker)
 #+ (1 | speech_rate)
 #+ (1 | ana_end_t)
  + (1 | ana_text)
  + (1 | foot_dur)
  )


optimizer = "optimx"
```

- model needs trimming (residuals +/- 3 s.d.)
```{r run h_t models, fig.height=3, fig.width=9}
pn_h_t_mdl = lmer(
  h_t_equation,
  pn_h_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
pn_h_t.trimmed <-
  pn_h_data %>% filter(abs(scale(resid(pn_h_t_mdl))) <= 3)

pn_h_t_mdl.trimmed = lmer(
  h_t_equation,
  pn_h_t.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)
summariseLME(pn_h_t_mdl.trimmed,
             run_step = TRUE,
             extra_text = "[prenuclear PA]",
             write = "pn_anovas/pn_h_t_anova.csv")
```

```{r plot h_t estimated effects, fig.height=3.5, fig.width=5}
plot_model(
  pn_h_t_mdl.trimmed,
  type = "est",
  transform = NULL,
  show.values = T,
  vline = "Red"
 )
```

```{r h_t model summary, fig.height=2.5, fig.width=5, results="asis"}
# tidyPrediction(pn_h_t_mdl.trimmed, write = "predictions/pn_h_t_mdl")

pn_h_t_mdl.tidy <- analyseModel(pn_h_t_mdl.trimmed,
                                write="pn_phonetic_models/pn_h_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )


pn_h_t_mdl.tidy$table

```

```{r do h_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  h_t_equation,
  pn_h_t.trimmed,
  optimizer,
  write="pn_phonetic_models/pn_h_t"
)
charts$intercepts
charts$slopes


```

### Analysis of H F0

- model dosn't work with SR, ana_end_t, or foot_dur (and suggested to be removed by step())
```{r set h_f0 equation}
h_f0_equation = formula(
  h_f0 ~ acc_phon
  + ana_syls
  + foot_syls
  + wrd_end_syl
  + pn_new_word
  + (1 | speaker)
  + (1 | ana_text)
  #+ (1 | speech_rate)
  #+ (1 | ana_end_t)
  #+ (1 | foot_dur)
  )

optimizer = "optimx"
```

```{r run h_f0 models, fig.height=3, fig.width=9}
pn_h_f0_mdl = lmer(
  h_f0_equation,
  pn_h_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)


summariseLME(pn_h_f0_mdl,
             run_step = TRUE,
             extra_text = "[prenuclear PA]",
             write = "pn_anovas/pn_h_f0_anova.csv")
```
```{r plot h_f0 estimated effects, fig.height=3.5, fig.width=5}
plot_model(
  pn_h_f0_mdl,
  type = "est",
  transform = NULL,
  show.values = T,
  vline = "Red"
 )
```

```{r h_f0 model summary, fig.height=2.5, fig.width=5, results="asis"}
# tidyPrediction(pn_h_f0_mdl, write = "predictions/pn_h_f0_mdl")
pn_h_f0_mdl.tidy <- analyseModel(pn_h_f0_mdl,
                                write="pn_phonetic_models/pn_h_f0",
                                type = "pred"
                                )
pn_h_f0_mdl.tidy$table

```

```{r do h_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  h_f0_equation,
  pn_h_data,
  optimizer,
  write="pn_phonetic_models/pn_h_f0"
)
charts$intercepts
charts$slopes


```


## Truncation and Compression Effects

Based on results from tonal target analysis, it looks there is an element of truncation in LH contours as a function of foot size, alongside a degree of rightward drift in L targets as foot size increases. However, superficially, it looks like the slope is stable.

As with nuclear data, I am retaining the overall model structure as much as possible BUT will discard all but foot_syls for analysis.

```{r get data ready for T and C analysis}
pn_tnc_data <- pn_l_data %>% 
  mutate(log_lh_slope = log(lh_slope)) %>% 
  filter(acc_phon == "L*H")
```
 
### LH Excursion

```{r set f0_exc equation}

f0_exc_equation = formula(
 f0_exc ~ foot_syls
  + ana_syls
  + pn_new_word
  + wrd_end_syl
  + gender
  + (1 | speaker)
 #+ (1 | speech_rate)
 #+ (1 | ana_end_t)
  + (1 | ana_text)
  + (1 | foot_dur)
  )

optimizer = "optimx"
```

```{r run f0_exc models, fig.height=3, fig.width=9}
pn_f0_exc_mdl = lmer(
  f0_exc_equation,
  pn_tnc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

```

- model needs trimming (|sd| residuals > 3)
```{r run lh_exc models trimmed, fig.height=3, fig.width=9}
# model needs trimming
pn_f0_exc.trimmed <-
  pn_tnc_data %>% filter(abs(scale(resid(pn_f0_exc_mdl))) <= 3)

pn_f0_exc_mdl.trimmed = lmer(
  f0_exc_equation,
  pn_f0_exc.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)
summariseLME(pn_f0_exc_mdl.trimmed,
             run_step = TRUE,
             write = "pn_anovas/pn_f0_exc_anova.csv")
```

```{r f0_exc model summary, fig.height=2.5, fig.width=4, results="asis"}

pn_f0_exc_mdl.tidy <- analyseModel(pn_f0_exc_mdl.trimmed,
                                write="pn_phonetic_models/pn_f0_exc",
                                type = "pred"
                                )
pn_f0_exc_mdl.tidy$table
##tidyPrediction(pn_f0_exc_mdl, write = "predictions/pn_f0_exc_mdl")

```
Results suggest it is in fact ana_syls which affects f0 excursions more!!!


```{r do f0_exc pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  f0_exc_equation,
  pn_f0_exc.trimmed,
  optimizer,
  write="pn_phonetic_models/pn_f0_exc"
  )
charts$intercepts
charts$slopes


```

### LH Slope


```{r set lh_slope equation}
lh_slope_equation = formula(log_lh_slope ~ foot_syls
  + ana_syls
  + pn_new_word
  + wrd_end_syl
  + gender
  + (1 | speaker)
 #+ (1 | speech_rate)
 #+ (1 | ana_end_t)
  + (1 | ana_text)
  + (1 | foot_dur)
  )

optimizer = "optimx"
```

- model needs trimming (|sd| residuals > 3.5)
```{r run lh_slope models, fig.height=3, fig.width=9}
pn_lh_slope_mdl = lmer(
  lh_slope_equation,
  pn_tnc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

```
- data needs trimming: residual SD > 4
```{r run lh_slope models trimmed, fig.height=3, fig.width=9}
# model needs trimming
pn_lh_slope.trimmed <-
  pn_tnc_data %>% filter(abs(scale(resid(pn_lh_slope_mdl))) <= 4)

pn_lh_slope_mdl.trimmed = lmer(
  lh_slope_equation,
  pn_lh_slope.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)
summariseLME(pn_lh_slope_mdl.trimmed,
             run_step = TRUE,
             extra_text = "[nuclear contour]",
             write = "pn_anovas/pn_lh_slope_anova.csv")
```

```{r lh_slope model summary, fig.height=2.5, fig.width=4, results="asis"}
##tidyPrediction(pn_lh_slope_mdl, write = "predictions/pn_lh_slope_mdl")

pn_lh_slope_mdl.tidy <- analyseModel(pn_lh_slope_mdl.trimmed,
                                write="pn_phonetic_models/pn_lh_slope",
                                type = "pred"
                                )
pn_lh_slope_mdl.tidy$table

```

```{r do lh_slope pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  lh_slope_equation,
  pn_lh_slope.trimmed,
  optimizer,
  write="pn_phonetic_models/pn_lh_slope"
)
charts$intercepts
charts$slopes


```
