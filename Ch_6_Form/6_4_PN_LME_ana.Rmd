---
title: "LME Analysis of PN and Anacrusis"
author: "Antoin Rodgers"
date: "18.05.2022"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

# Get personal functions and install / load necessary packages.
source("../functions/myFunctions.R")

installMissingPackages(
  c(
    # Include statistical packages.
    "performance",
    "lmerTest",
    "lme4",
    "ggeffects",
    "optimx",
    "MuMIn",
    "dfoptim",

    # Include packages for tidy output.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",

    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)

# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 14))

# Get  data for analysis

source("6_0_get_AH.R")

h_star_type <-  c("L*H", ">H*", "H*")
l_star_type <-  c("L*H", "L*")

pn_ana <- select(pn_ana,
                 # human factors
                 speaker, gender,
                 # phonological factors
                 acc_phon, ana_syls, 
                 # phonetic factors
                 wrd_end_t, speech_rate,
                 # responses
                 l_t, l_f0, h_t, h_f0, f0_exc, lh_slope) %>% 
  mutate(
    wrd_end_t_n = normalize(wrd_end_t),
    speech_rate_n = normalize(speech_rate),
    log_lh_slope = log(lh_slope)
    )


ana_lh_data <- pn_ana %>%
  filter(acc_phon %in% l_star_type) %>%
  mutate(acc_phon = factor(acc_phon, levels = l_star_type))

ana_h_data <- pn_ana %>%
  filter(acc_phon %in% h_star_type) %>%
  mutate(acc_phon = factor(acc_phon, levels = h_star_type)) %>%
  select(-c(l_t, l_f0))


```

```{r check levels in factors, results="asis", eval=FALSE}

cat("Tibble factors for ana_lh_data\n")
for (i in colnames(ana_lh_data)) {
  if (is.factor(ana_lh_data[[eval(i)]])) {
    cat("\n", i, "  \tlevels = ", levels(ana_lh_data[[i]]))
  }
  else {
    cat("\n", i)
    }
}
cat("\n\nacc_phon counts\n")
summary(ana_lh_data$acc_phon)

cat("\n\nTibble factors for ana_h_data\n")
for (i in colnames(ana_h_data)) {
  if (is.factor(ana_h_data[[eval(i)]])) {
    cat("\n", i, "  \tlevels = ", levels(ana_h_data[[i]]))
  }
    else {
    cat("\n", i)
    }
}
cat("\n\nacc_phon counts\n")
summary(ana_h_data$acc_phon)


```

NB: There is are no L* in the `pn_ana` corpus, so `acc_phon` cannot be used as a factor in the l-type models.

```{r Remove unwanted objects from environment}
rm(pn, nuc, nuc_foot, pn_lex, pn_ana, pn_foot, corpus, nuc_pre)
rm(stress, l_star_type, h_star_type)

```

### l_t

```{r ana_l_t Get best model, fig.height=3, fig.width=9}
ana_l_t_formula = formula(
  l_t ~ ana_syls + gender
  + (1 + ana_syls | speaker)
  + (1 | wrd_end_t_n)
  + (1 | speech_rate_n)
  )                         

ana_l_t_mdl = lmer(
  ana_l_t_formula,
  ana_lh_data,
  control = lmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# Check optimization and update model to most optimal
#ana_l_t_mdl <- optLme4Mdl(ana_l_t_mdl, reject_nl = T)

if(!modelIsOK(ana_l_t_mdl)){
  step_result <- step(ana_l_t_mdl)
  cat("Model found by step():", getModelFormula(get_model(step_result)), "\n")
}

cat("Updating formula.\n", sep ="")
ana_l_t_formula = formula(
  l_t ~
  ana_syls
  + gender
  + (1 + ana_syls | speaker)
  #+ (1 | wrd_end_t)
  #+ (1 | speech_rate)
  ) 

ana_l_t_mdl <- update(ana_l_t_mdl, formula = ana_l_t_formula)
# Check optimization and update model to most optimal
ana_l_t_mdl <- optLme4Mdl(ana_l_t_mdl)

first <- summariseLME(ana_l_t_mdl, print_summary = F)

# model needs trimming
sd_threshold = 4.5
cat("\nTrimming data with residual sd > ", sd_threshold, ".\n", sep ="")
ana_l_t_data.trimmed <-
  ana_lh_data %>% filter(abs(scale(resid(ana_l_t_mdl))) <= sd_threshold)

ana_l_t_mdl.trimmed <- update(ana_l_t_mdl, data = ana_l_t_data.trimmed)
ana_l_t_mdl.trimmed <- optLme4Mdl(ana_l_t_mdl.trimmed)


tibble(`Summary of model` = getModelFormula(ana_l_t_mdl.trimmed)) %>%
        formattable(align = "l")

anova <- summariseLME(ana_l_t_mdl.trimmed, 
                      write = "6_4_pn_subs_output/pn_ana_l_t_anova.csv")

adjustP_posthoc("6_4_pn_subs_output/",
                p.value,
                suffix_id = "_anova")

read_csv("6_4_pn_subs_output/pn_ana_l_t_anova.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("ANOVA of model:",
                            getModelFormula(ana_l_t_mdl.trimmed)))


```

```{r ana_l_t analyse model, fig.height=2.5, fig.width=3.01, results='asis'}
ana_l_t_mdl.tidy <- analyseModel(
  ana_l_t_mdl.trimmed
  , write="6_4_pn_subs_output/pn_ana_h_t"
  , type = "pred"
  , factor_matrix = TRUE
  )
```

```{r ana_l_t pairwise comparison, fig.height=2.5, fig.width=3.01}
charts <- getModelFixedFX(
  ana_l_t_mdl.trimmed,
  write="6_4_pn_subs_output/pn_ana_l_t",
)

adjustP_posthoc("6_4_pn_subs_output/",
                p.value,
                suffix_id = "_b0", marginal = T)
adjustP_posthoc("6_4_pn_subs_output/",
                p.value,
                suffix_id = "_b1", marginal = T)

read_csv("6_4_pn_subs_output/pn_ana_l_t_b0.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Intercepts of model:",
                            getModelFormula(ana_l_t_mdl.trimmed)))

read_csv("6_4_pn_subs_output/pn_ana_l_t_b1.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Slopes of model:",
                            getModelFormula(ana_l_t_mdl.trimmed)))

```

### l_f0

```{r ana_l_f0 Get best model, fig.height=3, fig.width=9}
ana_l_f0_formula = formula(
  l_f0 ~ ana_syls + gender
  + (1 + ana_syls | speaker)
  + (1 | wrd_end_t_n)
  + (1 | speech_rate_n)
  )                         

ana_l_f0_mdl = lmer(
  ana_l_f0_formula,
  ana_lh_data,
  control = lmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# Check optimization and update model to most optimal
#ana_l_f0_mdl <- optLme4Mdl(ana_l_f0_mdl, reject_nl = T)

if(!modelIsOK(ana_l_f0_mdl)){
  step_result <- step(ana_l_f0_mdl)
  cat("Model found by step():", getModelFormula(get_model(step_result)), "\n")
}

cat("Updating formula.\n", sep ="")
ana_l_f0_formula = formula(
  l_f0 ~
  ana_syls + gender
  + (1 + ana_syls | speaker)
  #+ (1 | wrd_end_t)
  #+ (1 | speech_rate)
  ) 

ana_l_f0_mdl <- update(ana_l_f0_mdl, formula = ana_l_f0_formula)
# Check optimization and update model to most optimal
ana_l_f0_mdl <- optLme4Mdl(ana_l_f0_mdl)

first <- summariseLME(ana_l_f0_mdl, print_summary = F)

# model needs trimming
sd_threshold = 4
cat("\nTrimming data with residual sd > ", sd_threshold, ".\n", sep ="")
ana_l_f0_data.trimmed <-
  ana_lh_data %>% filter(abs(scale(resid(ana_l_f0_mdl))) <= sd_threshold)

ana_l_f0_mdl.trimmed <- update(ana_l_f0_mdl, data = ana_l_f0_data.trimmed)
ana_l_f0_mdl.trimmed <- optLme4Mdl(ana_l_f0_mdl.trimmed)

tibble(`Summary of model` = getModelFormula(ana_l_f0_mdl.trimmed)) %>%
        formattable(align = "l")

anova <- summariseLME(
  ana_l_f0_mdl.trimmed
 , write = "6_4_pn_subs_output/pn_ana_l_f0_anova.csv"
  )

adjustP_posthoc("6_4_pn_subs_output/",
                p.value,
                suffix_id = "_anova")

read_csv("6_4_pn_subs_output/pn_ana_l_f0_anova.csv") %>%
  tidyStatNumbers() %>%
  formattable(caption = paste("ANOVA of model:",
                            getModelFormula(ana_l_f0_mdl.trimmed)))


```

```{r ana_l_f0 analyse model, fig.height=2.5, fig.width=3.01, results='asis'}
ana_l_f0_mdl.tidy <- analyseModel(
  ana_l_f0_mdl.trimmed
  , write="6_4_pn_subs_output/pn_ana_l_f0"
  , type = "pred"
  , factor_matrix = TRUE
  )
```

```{r ana_l_f0 pairwise comparison, fig.height=2.5, fig.width=3.01}
charts <- getModelFixedFX(ana_l_f0_mdl.trimmed, write="6_4_pn_subs_output/pn_ana_l_f0")

adjustP_posthoc("6_4_pn_subs_output/", p.value, suffix_id = "_b0", marginal = T)
adjustP_posthoc("6_4_pn_subs_output/", p.value, suffix_id = "_b1", marginal = T)

read_csv("6_4_pn_subs_output/pn_ana_l_f0_b0.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Intercepts of model:",
                            getModelFormula(ana_l_f0_mdl.trimmed)))

read_csv("6_4_pn_subs_output/pn_ana_l_f0_b1.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Slopes of model:",
                            getModelFormula(ana_l_f0_mdl.trimmed)))
```

### h_t

```{r ana_h_t Get best model, fig.height=3, fig.width=9}
ana_h_t_formula = formula(
  h_t ~ ana_syls + gender + acc_phon
  + (1 + ana_syls + acc_phon | speaker)
  + (1 | wrd_end_t_n)
  + (1 | speech_rate_n)
  )                         

ana_h_t_mdl = lmer(
  ana_h_t_formula,
  ana_h_data,
  control = lmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# Check optimization and update model to most optimal
#ana_h_t_mdl <- optLme4Mdl(ana_h_t_mdl, reject_nl = T)

if(!modelIsOK(ana_h_t_mdl)){
  step_result <- step(ana_h_t_mdl)
  cat("Model found by step():", getModelFormula(get_model(step_result)), "\n")
}

cat("Updating formula.\n", sep ="")
ana_h_t_formula = formula(
  h_t ~
  ana_syls + acc_phon + gender 
  + (1 + acc_phon| speaker)
  #+ (1 | wrd_end_t)
  #+ (1 | speech_rate)
  ) 

ana_h_t_mdl <- update(ana_h_t_mdl, formula = ana_h_t_formula)
# Check optimization and update model to most optimal
ana_h_t_mdl <- optLme4Mdl(ana_h_t_mdl)
ana_h_t_mdl <- update(
  ana_h_t_mdl,
  formula = ana_h_t_formula,
  control = lmerControl(
    optimizer = "nloptwrap",
    optCtrl = list(
      algorithm = "NLOPT_LN_COBYLA",
      maxfun = 1e9,
      maxeval = 1e7,
      xtol_abs = 1e-9,
      ftol_abs = 1e-9
    )
  )
)


first <- summariseLME(ana_h_t_mdl, print_summary = F)

# model needs trimming
sd_threshold = 2.5
cat("\nTrimming data with residual sd > ", sd_threshold, ".\n", sep ="")
ana_h_t_data.trimmed <-
  ana_h_data %>% filter(abs(scale(resid(ana_h_t_mdl))) <= sd_threshold)

ana_h_t_mdl.trimmed <- update(ana_h_t_mdl, data = ana_h_t_data.trimmed)
ana_h_t_mdl.trimmed <- optLme4Mdl(ana_h_t_mdl.trimmed)

tibble(`Summary of model` = getModelFormula(ana_h_t_mdl.trimmed)) %>%
        formattable(align = "l")

anova <- summariseLME(
  ana_h_t_mdl.trimmed
 , write = "6_4_pn_subs_output/pn_ana_h_t_anova.csv"
  )

adjustP_posthoc("6_4_pn_subs_output/",
                p.value,
                suffix_id = "_anova")

read_csv("6_4_pn_subs_output/pn_ana_h_t_anova.csv") %>%
  tidyStatNumbers() %>%
  formattable(caption = paste("ANOVA of model:",
                            getModelFormula(ana_h_t_mdl.trimmed)))


```

```{r ana_h_t analyse model, fig.height=2.5, fig.width=3.01, results = "asis"}
ana_h_t_mdl.tidy <- analyseModel(
  ana_h_t_mdl.trimmed
  , write="6_4_pn_subs_output/pn_ana_h_t"
  , type = "pred"
  , factor_matrix = TRUE
  )
```

```{r ana_h_t pairwise comparison, fig.height=2.5, fig.width=3.01}
charts <- getModelFixedFX(ana_h_t_mdl.trimmed, write="6_4_pn_subs_output/pn_ana_h_t")

adjustP_posthoc("6_4_pn_subs_output/", p.value, suffix_id = "_b0", marginal = T)
adjustP_posthoc("6_4_pn_subs_output/", p.value, suffix_id = "_b1", marginal = T)

read_csv("6_4_pn_subs_output/pn_ana_h_t_b0.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Intercepts of model:",
                            getModelFormula(ana_h_t_mdl.trimmed)))

read_csv("6_4_pn_subs_output/pn_ana_h_t_b1.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Slopes of model:",
                            getModelFormula(ana_h_t_mdl.trimmed)))



```

### h_f0

```{r ana_h_f0 Get best model, fig.height=3, fig.width=9}
ana_h_f0_formula = formula(
  h_f0 ~ ana_syls + acc_phon + gender
  + (1 + ana_syls + acc_phon | speaker)
  + (1 | wrd_end_t_n)
  + (1 | speech_rate_n)
  )    
ana_h_f0_mdl = lmer(
  ana_h_f0_formula,
  ana_h_data,
  control = lmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# Check optimization and update model to most optimal
#ana_h_f0_mdl <- optLme4Mdl(ana_h_f0_mdl, reject_nl = T)

if(!modelIsOK(ana_h_f0_mdl)){
  step_result <- step(ana_h_f0_mdl)
  cat("Model found by step():", getModelFormula(get_model(step_result)), "\n")
}

cat("Updating formula.\n", sep ="")
ana_h_f0_formula = formula(
  h_f0 ~ ana_syls +acc_phon + gender
  + (1 + ana_syls | speaker)
  #+ (1 | wrd_end_t_n)
  #+ (1 | speech_rate_n)
  ) 

ana_h_f0_mdl <- update(ana_h_f0_mdl, formula = ana_h_f0_formula)
# Check optimization and update model to most optimal
ana_h_f0_mdl <- optLme4Mdl(ana_h_f0_mdl)

#first <- summariseLME(ana_h_f0_mdl, print_summary = F)

tibble(`Summary of model` = getModelFormula(ana_h_f0_mdl)) %>%
        formattable(align = "l")

anova <- summariseLME(
  ana_h_f0_mdl
 , write = "6_4_pn_subs_output/pn_ana_h_f0_anova.csv"
  )

adjustP_posthoc("6_4_pn_subs_output/",
                p.value,
                suffix_id = "_anova")

read_csv("6_4_pn_subs_output/pn_ana_h_f0_anova.csv") %>%
  tidyStatNumbers() %>%
  formattable(caption = paste("ANOVA of model:",
                            getModelFormula(ana_h_f0_mdl)))


```

```{r ana_h_f0 analyse model, fig.height=2.5, fig.width=3.01, results = "asis"}
ana_h_f0_mdl.tidy <- analyseModel(
  ana_h_f0_mdl
  , write="6_4_pn_subs_output/pn_ana_h_f0"
  , type = "pred"
  , factor_matrix = TRUE
  )
```

```{r ana_h_f0 pairwise comparison, fig.height=2.5, fig.width=3.01}
charts <- getModelFixedFX(ana_h_f0_mdl, write="6_4_pn_subs_output/pn_ana_h_f0")

adjustP_posthoc("6_4_pn_subs_output/", p.value, suffix_id = "_b0", marginal = T)
adjustP_posthoc("6_4_pn_subs_output/", p.value, suffix_id = "_b1", marginal = T)

read_csv("6_4_pn_subs_output/pn_ana_h_f0_b0.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Intercepts of model:",
                            getModelFormula(ana_h_f0_mdl)))

read_csv("6_4_pn_subs_output/pn_ana_h_f0_b1.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Slopes of model:",
                            getModelFormula(ana_h_f0_mdl)))

```

### f0_exc

```{r ana_f0_exc Get best model, fig.height=3, fig.width=9}
ana_f0_exc_formula = formula(
  f0_exc ~ ana_syls + gender
  + (1 + ana_syls | speaker)
  + (1 | wrd_end_t_n)
  #+ (1 | speech_rate_n)
  )                         

ana_f0_exc_mdl = lmer(
  ana_f0_exc_formula,
  ana_lh_data,
  control = lmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# Check optimization and update model to most optimal
ana_f0_exc_mdl <- optLme4Mdl(ana_f0_exc_mdl, reject_nl = T)
# updating control manually because update() passes name of object and not just
# contents of object to its functions!
ana_f0_exc_mdl <- update(ana_f0_exc_mdl, data = ana_lh_data,
                         control = lmerControl(
                           optimizer = "nloptwrap",
                           optCtrl = list(algorithm = "NLOPT_LN_PRAXIS",
                                          maxfun = 1e9,
                                          maxeval = 1e7,
                                          xtol_abs = 1e-9,
                                          ftol_abs = 1e-9)))


tibble(`Summary of model` = getModelFormula(ana_f0_exc_mdl)) %>%
        formattable(align = "l")

anova <- summariseLME(
  ana_f0_exc_mdl,
  run_step = F
  , write = "6_4_pn_subs_output/pn_ana_f0_exc_anova.csv"
  )

adjustP_posthoc("6_4_pn_subs_output/",
                p.value,
                suffix_id = "_anova")

read_csv("6_4_pn_subs_output/pn_ana_f0_exc_anova.csv") %>%
  tidyStatNumbers() %>%
  formattable(caption = paste("ANOVA of model:",
                            getModelFormula(ana_f0_exc_mdl)))


```

```{r ana_f0_exc analyse model, fig.height=2.5, fig.width=3.01, results = "asis"}
ana_f0_exc_mdl.tidy <- analyseModel(
  ana_f0_exc_mdl
  , write="6_4_pn_subs_output/pn_ana_f0_exc"
  , type = "pred"
  , factor_matrix = TRUE
  )
```

```{r ana_f0_exc pairwise comparison, fig.height=2.5, fig.width=3.01}
charts <- getModelFixedFX(ana_f0_exc_mdl, write="6_4_pn_subs_output/pn_ana_f0_exc")
```

```{r}
adjustP_posthoc("6_4_pn_subs_output/", p.value, suffix_id = "_b0", marginal = T)
```

```{r}
adjustP_posthoc("6_4_pn_subs_output/", p.value, suffix_id = "_b1", marginal = T)
```

```{r}
read_csv("6_4_pn_subs_output/pn_ana_f0_exc_b0.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Intercepts of model:",
                            getModelFormula(ana_f0_exc_mdl)))
```

```{r}
read_csv("6_4_pn_subs_output/pn_ana_f0_exc_b1.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Slopes of model:",
                            getModelFormula(ana_f0_exc_mdl)))



```

### lh_slope

```{r ana_lh_slope Get best model, fig.height=3, fig.width=9}
ana_lh_slope_formula = formula(
  lh_slope ~ ana_syls + gender
  + (1 + ana_syls | speaker)
  + (1 | wrd_end_t_n)
  + (1 | speech_rate_n)
  )                         

ana_lh_slope_mdl = lmer(
  ana_lh_slope_formula,
  ana_lh_data,
  control = lmerControl(
    optimizer = "optimx",
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# Check optimization and update model to most optimal
ana_lh_slope_mdl <- optLme4Mdl(ana_lh_slope_mdl, reject_nl = T)

if(!modelIsOK(ana_lh_slope_mdl)){
  step_result <- step(ana_lh_slope_mdl)
  cat("Model found by step():", getModelFormula(get_model(step_result)), "\n")
}


#first <- summariseLME(ana_lh_slope_mdl, print_summary = F)

tibble(`Summary of model` = getModelFormula(ana_lh_slope_mdl)) %>%
        formattable(align = "l")

anova <- summariseLME(ana_lh_slope_mdl,
                      write ="6_4_pn_subs_output/pn_ana_lh_slope_anova.csv")

adjustP_posthoc("6_4_pn_subs_output/",
                p.value,
                suffix_id = "_anova")

read_csv("6_4_pn_subs_output/pn_ana_lh_slope_anova.csv") %>%
  tidyStatNumbers() %>%
  formattable(caption = paste("ANOVA of model:",
                            getModelFormula(ana_lh_slope_mdl)))


```

```{r ana_lh_slope analyse model, fig.height=2.5, fig.width=3.01, results = "asis"}
ana_lh_slope_mdl.tidy <- analyseModel(
  ana_lh_slope_mdl
  , write="6_4_pn_subs_output/pn_ana_lh_slope"
  , type = "pred"
  , factor_matrix = TRUE
  )
```

```{r ana_lh_slope pairwise comparison, fig.height=2.5, fig.width=3.01}
charts <- getModelFixedFX(ana_lh_slope_mdl, write="6_4_pn_subs_output/pn_ana_lh_slope")


adjustP_posthoc("6_4_pn_subs_output/", p.value, suffix_id = "_b0", marginal = T)
adjustP_posthoc("6_4_pn_subs_output/", p.value, suffix_id = "_b1", marginal = T)

read_csv("6_4_pn_subs_output/pn_ana_lh_slope_b0.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Intercepts of model:",
                            getModelFormula(ana_lh_slope_mdl)))

read_csv("6_4_pn_subs_output/pn_ana_lh_slope_b1.csv") %>%
  tidyStatNumbers() %>%
formattable(caption = paste("Slopes of model:",
                            getModelFormula(ana_lh_slope_mdl)))


```
