---
title: "BGLMM Analysis of PN Phonology"
author: "AERodgers"
date: "2/18/2022"
output:
  html_document: default
---

```{r setup, include=FALSE,}
knitr::opts_chunk$set(echo = FALSE,
                      warning = F,
                      message = F)

```


```{r message=FALSE}
# Get personal functions and install / load necessary packages.
source("../functions/myFunctions.R")

installMissingPackages(
  c(
    # Include statistical packages.
    "lmerTest",
    "blme",
    "optimx",
    "MuMIn",
    
    # Include packages for tidy output.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",
    "ggeffects",
    
    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)

# Get data frames for AH analysis
source("6_0_get_AH.R")
# Add isLH column


pn <- pn %>%
  select(
    speaker,
    gender,
    foot_syls,
    acc_phon,
    wrd_end_syl,
    ana_text,
    nuc_pre_text,
    pn_new_word,
    acc_phon,
    speech_rate,
    ana_end_t,
    foot_dur
  ) %>%
  mutate(
    isLH = factor(if_else(acc_phon == "L*H",
                          TRUE,
                          FALSE),
                  levels = c(F, T)),
    isHStar = factor(if_else(acc_phon == "H*",
                             TRUE,
                             FALSE),
                     levels = c(F, T)),
    foot_dur = foot_dur / 100,
    gender = factor(gender, levels = c("F", "M")),
    foot_syls = factor(foot_syls, levels = 1:4)
  )

rm(nuc, nuc_foot, pn_lex, pn_ana, pn_foot, corpus, nuc_pre)


# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 14))



```

- As step cannot be used, effects were systematically removed and added piecewise till maximal working model was found.
- There appears to be an interaction of foot_syls:pn_new_word but no independent effect of pn_new_word
- Running bobyaqa optimizer works best.

- Looking at fixed effects:
    - pn_new_word no meaningful effect [est. 0.219, CIs -3.06, 3.50]
    - gender weak: [est. -1.758, CIs -3.74, 0.22]

- Looking at random effects:
    - ana_end_t is negligible
    - foot_dur is very weak

```{r set isLH equation}
isLH_equation <- formula(isLH ~
                         foot_syls
                         + wrd_end_syl
                         + speech_rate
                         + gender
                         + (1 | nuc_pre_text)
                         + (1 | speaker)
                         + (1 | ana_text)
                         + (1 | foot_dur)
                         )

```

#### Run isLH model

```{r run isLH models}
lh_pn_model <- bglmer(
  isLH_equation,
  data = pn,
  fixef.prior = normal(),
  family = binomial(link = "logit"),
  glmerControl(optimizer = "bobyqa")
)

summary(lh_pn_model)

```

```{r random effect of prompt, fig.height=3, fig.width=4}
plot_model(lh_pn_model,
           type="re",
           show.values = T, ci.lvl= 0.95,
           transform = NULL
           )[2:4]
```

```{r, results = "asis"}
tidyPrintPredictions(lh_pn_model) 
```

```{r run null modelsLH anovas}
isLH_null_eq_1 <- formula(isLH ~
                         #foot_syls
                         + wrd_end_syl
                         + speech_rate
                         + gender
                         + (1 | nuc_pre_text)
                         + (1 | speaker)
                         + (1 | ana_text)
                         + (1 | foot_dur)
                         )

isLH_null_eq_2 <- formula(isLH ~
                         foot_syls
                         #+ wrd_end_syl
                         + speech_rate
                         + gender
                         + (1 | nuc_pre_text)
                         + (1 | speaker)
                         + (1 | ana_text)
                         + (1 | foot_dur)
                         )
  
isLH_null_eq_3 <- formula(isLH ~
                         foot_syls
                         + wrd_end_syl
                         #+ speech_rate
                         + gender
                         + (1 | nuc_pre_text)
                         + (1 | speaker)
                         + (1 | ana_text)
                         + (1 | foot_dur)
                         )

isLH_null_eq_4 <- formula(isLH ~
                         foot_syls
                         + wrd_end_syl
                         + speech_rate
                         #+ gender
                         + (1 | nuc_pre_text)
                         + (1 | speaker)
                         + (1 | ana_text)
                         + (1 | foot_dur)
                         )

null_model_1 <- bglmer(
  isLH_null_eq_1,
  data = pn,
  family = binomial(link = "logit"),
  glmerControl(optimizer = "bobyqa")
)

null_model_2 <- bglmer(
  isLH_null_eq_2,
  data = pn,
  family = binomial(link = "logit"),
  glmerControl(optimizer = "bobyqa")
)

null_model_3 <- bglmer(
  isLH_null_eq_3,
  data = pn,
  family = binomial(link = "logit"),
  glmerControl(optimizer = "bobyqa")
)

null_model_4 <- bglmer(
  isLH_null_eq_4,
  data = pn,
  family = binomial(link = "logit"),
  glmerControl(optimizer = "bobyqa")
)

# get, save, and print ANOVA of model
anova_1 <- anova(lh_pn_model, null_model_1, test="Chisq") %>% 
  outputChiSqResults(lh_pn_model)
  
  
anova_2 <- anova(lh_pn_model, null_model_2, test="Chisq") %>%
  outputChiSqResults(lh_pn_model)

anova_3 <- anova(lh_pn_model,
           null_model_3, test="Chisq") %>%
  outputChiSqResults(lh_pn_model)

anova_4 <- anova(lh_pn_model,
           null_model_4, test="Chisq") %>%
  outputChiSqResults(lh_pn_model)


write <- "phonology_models/lh_model"
model_formula <- getModelFormula(lh_pn_model)

cbind(
  effect = c("foot_syls", "wrd_end_syl", "speech_rate", "gender"),
  rbind(anova_1, anova_2, anova_3, anova_4) %>%
    as_tibble %>% filter(!is.na(Chisq))
) %>%
  mutate(`p.adj (BH)` = NA, signif. = NA) %>%
  write_csv(paste(write, "_anova.csv", sep = "")) %>%
  select(-c(`p.adj (BH)`, signif.))  %>%
  formattable(caption = model_formula)

 write(paste(str_replace_all(model_formula, "\\`", ""), sep = ""),
          paste(write, "_formula.txt", sep = ""))
```

```{r model charts and figures, fig.width = 4.5, fig.height = 2.5, results="asis"}
cat(
  "isSingular(lh_pn_model, tol=1e-5) -->",
  isSingular(lh_pn_model, tol = 1e-5),
  "\n"
)



tidy_summary <- analyseModel(lh_pn_model,
                             write = "phonology_models/lh_model",
                             is_GLM = TRUE,
                             type = "pred",
                             ci.lvl=0.95
                             )

ggpredict(lh_pn_model, terms = "speech_rate [all]", ci.lvl = 0.95) %>%
  plot() +
  xlim(2.874, 9.284) +
  xlab("speech rate (syls/sec)") +
  ylab("L*H") +
  labs(title = "Predicted probabilities of L*H re speech rate",
       caption = "Predicted probabilities of L*H re speech rate with 95% CIs") +
  scale_y_continuous(labels = scales::percent)

plot_model(
  lh_pn_model,
  type = "est",
  transform = NULL,
  show.values = T,
  vline = "Red"
 )

tidy_summary$table

charts <- getModelFixedFX(
  isLH_equation,
  pn,
  write="phonology_models/lh_model",
  is_GLM=TRUE,
  is_separation = T,
  b1_only = "speech_rate"
)

charts$intercepts
charts$slopes
```

## Run isHStar model
- Removed foot_dur as random slope due to estimation errors.
```{r set isHStar equation}
isHStar_equation <- formula(isHStar ~ foot_syls
                            + wrd_end_syl
                            + speech_rate
                            + gender
                            + (1 | nuc_pre_text)
                            + (1 | speaker)
                            + (1 | ana_text)
                           # + (1 | foot_dur)
                            )

null_equation <- formula(isHStar ~ 1
                         + (1 | nuc_pre_text)
                         + (1 | speaker)
                         + (1 | ana_text)
                         #+ (1 | foot_dur)
                            )

```

```{r}
h_star_model <- bglmer(
  isHStar_equation,
  pn,
  fixef.prior = normal(),
  family = binomial(link = "logit"),
  glmerControl(optimizer = "bobyqa")
)

summary(h_star_model)
```


```{r fig.height=4, fig.width=5, results = "asis"}
plot_model(h_star_model,
           type="re",
           show.values = T)
```


```{r, results = "asis"}

tidyPrintPredictions(h_star_model) 
```

```{r run models H anovas}


isHStar_null_eq_1 <- formula(isHStar ~
                           #foot_syls
                          wrd_end_syl
                         + speech_rate
                         + gender
                         + (1 | nuc_pre_text)
                         + (1 | speaker)
                         + (1 | ana_text)
                         #+ (1 | foot_dur)
                         )
  
isHStar_null_eq_2 <- formula(isHStar ~
                           foot_syls
                         #+ wrd_end_syl
                         + speech_rate
                         + gender
                         + (1 | nuc_pre_text)
                         + (1 | speaker)
                         + (1 | ana_text)
                         #+ (1 | foot_dur)
                         )

isHStar_null_eq_3 <- formula(isHStar ~
                           foot_syls
                         + wrd_end_syl
                         #+ speech_rate
                         + gender
                         + (1 | nuc_pre_text)
                         + (1 | speaker)
                         + (1 | ana_text)
                         #+ (1 | foot_dur)
                         )

isHStar_null_eq_4 <- formula(isHStar ~
                           foot_syls
                         + wrd_end_syl
                         + speech_rate
                         #+ gender
                         + (1 | nuc_pre_text)
                         + (1 | speaker)
                         + (1 | ana_text)
                         #+ (1 | foot_dur)
                         )

null_model_1 <- bglmer(
  isHStar_null_eq_1,
  data = pn,
  family = binomial(link = "logit"),
  glmerControl(optimizer = "bobyqa")
)

null_model_2 <- bglmer(
  isHStar_null_eq_2,
  data = pn,
  family = binomial(link = "logit"),
  glmerControl(optimizer = "bobyqa")
)

null_model_3 <- bglmer(
  isHStar_null_eq_3,
  data = pn,
  family = binomial(link = "logit"),
  glmerControl(optimizer = "bobyqa")
)

null_model_4 <- bglmer(
  isHStar_null_eq_4,
  data = pn,
  family = binomial(link = "logit"),
  glmerControl(optimizer = "bobyqa")
)

# get, save, and print ANOVA of model
anova_1 <- anova(h_star_model, null_model_1, test="Chisq") %>% 
  outputChiSqResults(lh_pn_model)
  
  
anova_2 <- anova(h_star_model, null_model_2, test="Chisq") %>%
  outputChiSqResults(lh_pn_model)

anova_3 <- anova(h_star_model,
           null_model_3, test="Chisq") %>%
  outputChiSqResults(lh_pn_model)

anova_4 <- anova(h_star_model,
           null_model_4, test="Chisq") %>%
  outputChiSqResults(lh_pn_model)


write <- "phonology_models/h_star_model"
model_formula <- getModelFormula(h_star_model)

cbind(
  effect = c("foot_syls", "wrd_end_syl", "speech_rate", "gender"),
  rbind(anova_1, anova_2, anova_3, anova_4) %>%
    as_tibble %>% filter(!is.na(Chisq))
) %>%
  mutate(`p.adj (BH)` = NA, signif. = NA) %>%
  write_csv(paste(write, "_anova.csv", sep = "")) %>%
  select(-c(`p.adj (BH)`, signif.))  %>%
  formattable(caption = model_formula)

 write(paste(str_replace_all(model_formula, "\\`", ""), sep = ""),
          paste(write, "_formula.txt", sep = ""))
```



```{r fig.width = 4, fig.height = 2.5, results="asis"}
cat(
  "isSingular(h_star_model, tol=1e-5) -->",
  isSingular(h_star_model, tol = 1e-5),
  "\n"
)

tidy_summary <- analyseModel(h_star_model,
                             write = "phonology_models/h_star_model",
                             is_GLM = TRUE,
                             type = "pred")


ggpredict(h_star_model, terms = "speech_rate [all]", ci.lvl = 0.95) %>%
  plot() +
  xlim(2.874, 9.284) +
  xlab("speech rate (syls/sec)") +
  ylab("H*") +
  labs(title = "Predicted probabilities of H* re speech rate",
       caption = "Predicted probabilities of H* re speech rate with 95% CIs") +
  scale_y_continuous(labels = scales::percent)


plot_model(
  h_star_model,
  type = "est",
  transform = NULL,
  show.values = T,
  vline = "Red"
 )

charts <- getModelFixedFX(
  isHStar_equation,
  pn,
  write="phonology_models/h_star_model",
  is_GLM=TRUE,
  is_separation = T,
  b1_only = "speech_rate"
)

charts$intercepts
charts$slopes
```
