---
title: "LME Analysis of NUCs"
author: "Antoin Rodgers"
date: "18.05.2022"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# Get personal functions and install / load necessary packages.
source("../functions/myFunctions.R")

installMissingPackages(
  c(
    # Include statistical packages.
    "performance",
    "lmerTest",
    "lme4",
    "ggeffects",
    "optimx",
    "MuMIn",
    "dfoptim",

    # Include packages for tidy output.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",
    "janitor",
    
    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)

# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 14))

# Get  data for analysis

source("6_0_get_AH.R")

nuc_data <- nuc %>%
  # there must be a more efficient way of doing this but...
  # Create column of stressed syllables in foot 2.
    select(
    stim,
    speaker,
    gender,
    pre_syls,
    foot_syls,
    nuc_pre_text,
    nuc_new_word,
    nuc_str_syl,
    fin_phon,
    stim,
    h_t,
    h_f0,
    l_t,
    l_f0,
    e_t,
    e_f0,
    f0_exc,
    lh_dur,
    lh_slope,
    foot_dur,
    speech_rate
  )




rm(pn, nuc, pn_ana, pn_foot, nuc_pre, nuc_foot, pn_lex, corpus)

```

```{r check levels in factors, results="asis", eval=FALSE}

cat("Tibble factors for nuc_data\n")
for (i in colnames(nuc_data))
{
  if (is.factor(nuc_data[[eval(i)]]))
  {
    cat("\n", i, "\tlevels = ", levels(nuc_data[[i]]))
  }
  else
  {
    cat("\n", i)
    }
  
}

nuc_data %>%
  group_by(stim, pre_syls) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = pre_syls, values_from = count, values_fill = 0) %>%
  adorn_totals("row") %>% 
  formattable(caption = "pre_syls stim variety")

nuc_data %>%
  group_by(stim, nuc_new_word) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = nuc_new_word, values_from = count, values_fill = 0) %>%
  adorn_totals("row") %>% 
  formattable(caption = "nuc_new_word stim variety")
```

## L targets

### Analysis of L timing

- initial run, step() found: `l_t ~ pre_syls + gender + (1 | speaker) + (1 | nuc_str_syl)`
- 
```{r set l_t equation}
l_t_equation = formula(
  l_t ~ foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
# + (1 | speech_rate)
  + (1 | nuc_str_syl)
  + (1 | foot_dur)
# + (1 | nuc_pre_text)
  )

optimizer = "optimx"
```

- intercepts only model, needs trimming: rfemoved residual sd > 3

```{r run l_t models, fig.height=3, fig.width=9}
nuc_l_t_mdl = lmer(
  l_t_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_l_t_data.trimmed <-
  nuc_data %>% filter(abs(scale(resid(nuc_l_t_mdl))) <= 3)

nuc_l_t_mdl = lmer(
  l_t_equation,
  nuc_l_t_data.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)
summariseLME(nuc_l_t_mdl,
             run_step = TRUE,
             write = "nuc_anovas/nuc_l_t_anova.csv")
```

```{r l_t model summary, fig.height=2.5, fig.width=5, results="asis"}
plot_model(nuc_l_t_mdl, type = "re",
           caption = "Random effects of stressed syllable")[3]

##tidyPrediction(nuc_l_t_mdl, write = "predictions/nuc_l_t_mdl")

nuc_l_t_mdl.tidy <- analyseModel(nuc_l_t_mdl,
                                write="nuc_phonetic_models/nuc_l_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )
nuc_l_t_mdl.tidy$table

```

```{r do l_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  l_t_equation,
  nuc_data,
  optimizer,
  write="nuc_phonetic_models/nuc_l_t"
)
charts$intercepts
charts$slopes


```

### Analysis of L F0

- Only intercepts only model avoided convergence and singularity issues
- step() suggests: `l_f0 ~ foot_syls + gender + (1 | speaker) + (1 | nuc_pre_text)`
- but random intercepts only model words
- removed  speech_rate and nuc_str_syl random effects to eliminate singularity in getModelFixedFX()

```{r set l_f0 equation}

l_f0_equation = formula(
l_f0 ~ foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + (1 | speaker)
 # + (1 | speech_rate)
 # + (1 | nuc_str_syl)
  + (1 | foot_dur)
  + (1 | nuc_pre_text)
  )
optimizer = "optimx"
```

- model needs trimming (sd residuals > 3)
```{r run l_f0 models, fig.height=3, fig.width=9}
nuc_l_f0_mdl = lmer(
  l_f0_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_l_f0.trimmed <-
  nuc_data %>% filter(abs(scale(resid(nuc_l_f0_mdl))) <= 3)

nuc_l_f0_mdl.trimmed = lmer(
  l_f0_equation,
  nuc_l_f0.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(nuc_l_f0_mdl.trimmed,
             run_step = TRUE,
             write = "nuc_anovas/nuc_l_f0_anova.csv")
```

```{r l_f0 model summary, fig.height=2.5, fig.width=5, results="asis"}
##tidyPrediction(nuc_l_f0_mdl.trimmed, write = "predictions/nuc_l_f0_mdl")

nuc_l_f0_mdl.tidy <- analyseModel(nuc_l_f0_mdl.trimmed,
                                write="nuc_phonetic_models/nuc_l_f0",
                                type = "pred"
                                )
nuc_l_f0_mdl.tidy$table

```

```{r do l_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  l_f0_equation,
  nuc_l_f0.trimmed,
  optimizer,
  write="nuc_phonetic_models/nuc_l_f0"
)
charts$intercepts
charts$slopes


```

## H targets

### Analysis of H timing

- Only intercepts only model avoided convergence and singularity issues
- step() suggests: `h_t ~ foot_syls + pre_syls + fin_phon + nuc_new_word + gender + (1 | speaker) + (1 | nuc_str_syl)`
- Removing speech_rate, foot_dur, and nuc_pre_text random intercepts
```{r set h_t equation}
h_t_equation = formula(
  h_t ~ foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
# + (1 | speech_rate)
  + (1 | nuc_str_syl)
# + (1 | foot_dur)
# + (1 | nuc_pre_text)
  )

optimizer = "optimx"
```

-  model needs trimming (residual sd > 3.5)

```{r run h_t models, fig.height=3, fig.width=9}
nuc_h_t_mdl = lmer(
  h_t_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_h_t_data.trimmed <-
  nuc_data %>% filter(abs(scale(resid(nuc_h_t_mdl))) <= 3.5)

nuc_h_t_mdl = lmer(
  h_t_equation,
  nuc_h_t_data.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(nuc_h_t_mdl,
             run_step = TRUE,
             write = "nuc_anovas/nuc_h_t_anova.csv")
```


```{r h_t model summary, fig.height=2.5, fig.width=5, results="asis"}
##tidyPrediction(nuc_h_t_mdl, write = "predictions/nuc_h_t_mdl")

nuc_h_t_mdl.tidy <- analyseModel(nuc_h_t_mdl,
                                write="nuc_phonetic_models/nuc_h_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )
nuc_h_t_mdl.tidy$table

```

```{r do h_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  h_t_equation,
  nuc_data,
  optimizer,
  write="nuc_phonetic_models/nuc_h_t"
)
charts$intercepts
charts$slopes
```

### Analysis of H F0

step() suggests: `h_f0 ~ foot_syls + fin_phon + gender + (1 | speaker) + (1 | nuc_pre_text)`
- but retaining all fixed effects, and only removing `(1 | foot_dur) + (1 | nuc_pre_text)`

```{r set h_f0 equation}
h_f0_equation = formula(
  h_f0 ~ foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + (1 | speaker)
  + (1 | speech_rate)
  + (1 | nuc_str_syl)
  #+ (1 | foot_dur)
  #+ (1 | nuc_pre_text)
  )

optimizer = "optimx"
```

- model needs trimming (residuals +/- 4 s.d.)
```{r run h_f0 models, fig.height=3, fig.width=9}
nuc_h_f0_mdl = lmer(
  h_f0_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_h_f0.trimmed <-
  nuc_data %>% filter(abs(scale(resid(nuc_h_f0_mdl))) <= 4)

nuc_h_f0_mdl.trimmed = lmer(
  h_f0_equation,
  nuc_h_f0.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(nuc_h_f0_mdl.trimmed,
             run_step = TRUE,
             write = "nuc_anovas/nuc_h_f0_anova.csv")
```

```{r h_f0 model summary, fig.height=2.5, fig.width=5, results="asis"}
##tidyPrediction(nuc_h_f0_mdl, write = "predictions/nuc_h_f0_mdl")

nuc_h_f0_mdl.tidy <- analyseModel(nuc_h_f0_mdl,
                                write="nuc_phonetic_models/nuc_h_f0",
                                type = "pred"
                                )
nuc_h_f0_mdl.tidy$table

```

```{r do h_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  h_f0_equation,
  nuc_data,
  optimizer,
  write="nuc_phonetic_models/nuc_h_f0"
)
charts$intercepts
charts$slopes


```

## E targets

### Analysis of E timing

- NB, E timing is not of interest!
-  initial step() suggests:
-  `e_t ~ foot_syls + pre_syls + fin_phon + nuc_new_word + gender + (1 | speaker) + (1 | nuc_str_syl) + (1 | foot_dur) + (1 | nuc_pre_text) `

- rerunning without `(1 | speech_rate)`, it suggests:
`e_t ~ foot_syls + pre_syls + gender + (1 | speaker) + (1 | nuc_str_syl) + (1 | foot_dur)`

- However, model words, so retaining it.

```{r set e_t equation}
e_t_equation = formula(
  e_t ~ foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
 #  (1 | speech_rate)
  + (1 | nuc_str_syl)
  + (1 | foot_dur)
  + (1 | nuc_pre_text)
  )

optimizer = "optimx"
```

- intercepts only model
- model needs trimming
```{r run e_t models, fig.height=3, fig.width=9}
nuc_e_t_mdl = lmer(
  e_t_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_e_t.trimmed <-
  nuc_data %>% filter(abs(scale(resid(nuc_e_t_mdl))) <= 4)

nuc_e_t_mdl.trimmed = lmer(
  e_t_equation,
  nuc_e_t.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(nuc_e_t_mdl.trimmed,
             run_step = TRUE,
             extra_text = "[nuclear contour]",
             write = "nuc_anovas/nuc_e_t_anova.csv")
```

```{r e_t model summary, fig.height=2.5, fig.width=5, results="asis"}
##tidyPrediction(nuc_e_t_mdl.trimmed, write = "predictions/nuc_e_t_mdl")

nuc_e_t_mdl.tidy <- analyseModel(nuc_e_t_mdl.trimmed,
                                write="nuc_phonetic_models/nuc_e_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )
nuc_e_t_mdl.tidy$table

```

```{r do e_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  e_t_equation,
  nuc_e_t.trimmed,
  optimizer,
  write="nuc_phonetic_models/nuc_e_t"
)
charts$intercepts
charts$slopes


```

### Analysis of E F0

- Only intercepts only model avoided convergence and singularity issues
- initial step() suggested: `e_f0 ~ foot_syls + fin_phon + gender + (1 | speaker) + (1 | nuc_pre_text)`
- model words once random intercepts of speech_rate and nuc_str_syl are removed
- foot_dur removed to prevent singularity in getModelFixedFX()

```{r set e_f0 equation}
e_f0_equation = formula(
  e_f0 ~ foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + (1 | speaker)
# +  (1 | speech_rate)
#  + (1 | nuc_str_syl)
#  + (1 | foot_dur)
  + (1 | nuc_pre_text)
  )

optimizer = "optimx"
```

- model needs trimming (|sd| residuals > 3.5)
```{r run e_f0 models, fig.height=3, fig.width=9}
nuc_e_f0_mdl = lmer(
  e_f0_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_e_f0.trimmed <-
  nuc_data %>% filter(abs(scale(resid(nuc_e_f0_mdl))) <= 3.5)

nuc_e_f0_mdl.trimmed = lmer(
  e_f0_equation,
  nuc_e_f0.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(nuc_e_f0_mdl.trimmed,
             run_step = TRUE,
             extra_text = "[nuclear contour]",
             write = "nuc_anovas/nuc_e_f0_anova.csv")
```


```{r e_f0 model summary, fig.height=2.5, fig.width=5, results="asis"}
##tidyPrediction(nuc_e_f0_mdl, write = "predictions/nuc_e_f0_mdl")

nuc_e_f0_mdl.tidy <- analyseModel(nuc_e_f0_mdl,
                                write="nuc_phonetic_models/nuc_e_f0",
                                type = "pred"
                                )
nuc_e_f0_mdl.tidy$table

```

```{r do e_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  e_f0_equation,
  nuc_data,
  optimizer,
  write="nuc_phonetic_models/nuc_e_f0"
)
charts$intercepts
charts$slopes
```


## Truncation and Compression Effects

NB: only foot_syls is of interest here, not pre-syls or fin-phon
However, to preserve previous models, they are included as fixed effects,
but they are discarded.

- step() suggests: `f0_exc ~ foot_syls + fin_phon + (1 | speaker) + (1 | nuc_pre_text)`
- model works after removing random intercepts of speech_rate, nuc_str_syl, and foot_dur.
### LH Excursion

```{r set f0_exc equation}

f0_exc_equation = formula(
 f0_exc ~ foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
# + (1 | speech_rate)
#  + (1 | nuc_str_syl)
# + (1 | foot_dur)
  + (1 | nuc_pre_text)
  )

optimizer = "optimx"
```

- model needs trimming (|sd| residuals > 2.5)
```{r run f0_exc models, fig.height=3, fig.width=9}
nuc_f0_exc_mdl = lmer(
  f0_exc_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

```

```{r run lh_exc models trimmed, fig.height=3, fig.width=9}
# model needs trimming
nuc_f0_exc.trimmed <-
  nuc_data %>% filter(abs(scale(resid(nuc_f0_exc_mdl))) <= 2.5)

nuc_f0_exc_mdl.trimmed = lmer(
  f0_exc_equation,
  nuc_f0_exc.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)
summariseLME(nuc_f0_exc_mdl.trimmed,
             run_step = TRUE,
             write = "nuc_anovas/nuc_f0_exc_anova.csv")
```

```{r f0_exc model summary, fig.height=2.5, fig.width=4, results="asis"}

nuc_f0_exc_mdl.tidy <- analyseModel(nuc_f0_exc_mdl.trimmed,
                                write="nuc_phonetic_models/nuc_f0_exc",
                                type = "pred"
                                )
nuc_f0_exc_mdl.tidy$table
##tidyPrediction(nuc_f0_exc_mdl, write = "predictions/nuc_f0_exc_mdl")

```

```{r do f0_exc pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  f0_exc_equation,
  nuc_f0_exc.trimmed,
  optimizer,
  write="nuc_phonetic_models/nuc_f0_exc",
  ignore_list = c("pre_syls", "fin_phon")
)
charts$intercepts
charts$slopes


```


### LH Slope

Based on results from tonal target analysis, it looksl like compression and truncation may be in effect.
As compression leads to decrease in duration of rise (but not necessarily much descrease in excursion size),
and as slope increases exponentially as duration decreases, slope has been logged here.

initial step() suggests: `log_lh_slope ~ foot_syls + (1 | speaker) + (1 | nuc_pre_text)`
- model works once random intercepts of speech_rate and foot_dur removed
```{r set lh_slope equation}
nuc_data <- nuc_data %>% 
    mutate(log_lh_slope = log(lh_slope))

lh_slope_equation = formula(
  log_lh_slope ~ foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
# + (1 | speech_rate)
  + (1 | nuc_str_syl)
# + (1 | foot_dur)
  + (1 | nuc_pre_text)
  )
optimizer = "optimx"
```

- model needs trimming (|sd| residuals > 3.5)
```{r run lh_slope models, fig.height=3, fig.width=9}
nuc_lh_slope_mdl = lmer(
  lh_slope_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

```

```{r run lh_slope models trimmed, fig.height=3, fig.width=9}
# model needs trimming
nuc_lh_slope.trimmed <-
  nuc_data %>% filter(abs(scale(resid(nuc_lh_slope_mdl))) <= 3)

nuc_lh_slope_mdl.trimmed = lmer(
  lh_slope_equation,
  nuc_lh_slope.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)
summariseLME(nuc_lh_slope_mdl.trimmed,
             run_step = TRUE,
             write = "nuc_anovas/nuc_lh_slope_anova.csv")
```

```{r lh_slope model summary, fig.height=2.5, fig.width=4, results="asis"}
##tidyPrediction(nuc_lh_slope_mdl, write = "predictions/nuc_lh_slope_mdl")

nuc_lh_slope_mdl.tidy <- analyseModel(nuc_lh_slope_mdl.trimmed,
                                write="nuc_phonetic_models/nuc_lh_slope",
                                type = "pred"
                                )
nuc_lh_slope_mdl.tidy$table

```

```{r do lh_slope pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  lh_slope_equation,
  nuc_lh_slope.trimmed,
  optimizer,
  write="nuc_phonetic_models/nuc_lh_slope",
  ignore_list = c("pre_syls", "fin_phon")
)
charts$intercepts
charts$slopes


```
