---
title: "LME Analysis of anacrusis PNs"
author: "Antoin Rodgers"
date: "18.05.2022"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# Get personal functions and install / load necessary packages.
source("../functions/myFunctions.R")

installMissingPackages(
  c(
    # Include statistical packages.
    "performance",
    "lmerTest",
    "lme4",
    "ggeffects",
    "optimx",
    "MuMIn",

    
    # Include packages for tidy output.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",
    
    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)



# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 14))
```

## H targets

```{r h Get data}
# Get  data for analysis
h_star_type <-  c("H*", ">H*", "L*H")
source("6_0_get_AH.R")

rm(nuc_foot, nuc_pre, pn_lex, pn_foot, pn, corpus, nuc)

pn_ana_h <- pn_ana %>% 
  select(speaker, gender, ana_syls, acc_phon,h_t, h_f0, lh_dur, foot_dur, speech_rate) %>% 
  filter(acc_phon %in% h_star_type) %>% 
  mutate(acc_phon = factor(acc_phon, levels = h_star_type))

```

### Analysis of H timing

- Only intercepts only model avoided convergence and singularity issues
```{r set h_t equation}
h_t_equation = formula(
  h_t ~ acc_phon + ana_syls + gender
  + (1 | speaker)
  + (1 | speech_rate)
  )

optimizer = "optimx"
```

- model needs trimming (residuals +/- 3 s.d.)
```{r run h_t models, fig.height=3, fig.width=9}
pn_ana_h_t_mdl = lmer(
  h_t_equation,
  pn_ana_h,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
pn_ana_h_t.trimmed <- pn_ana_h %>% filter(abs(scale(resid(pn_ana_h_t_mdl))) <= 3)

pn_ana_h_t_mdl.trimmed = lmer(
  h_t_equation,
  pn_ana_h_t.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

allFit(pn_ana_h_t_mdl.trimmed)
summariseLME(pn_ana_h_t_mdl.trimmed, run_step = TRUE, write = "anovas/pn_ana_h_t.csv")
```


```{r h_t model summary, fig.height=3.5, fig.width=7, results="asis"}

pn_ana_h_t_mdl.trimmed.tidy <- analyseModel(pn_ana_h_t_mdl.trimmed,
                                write="phonetic_models/pn_ana_h_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )
pn_ana_h_t_mdl.trimmed.tidy$table

```

```{r do h_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  h_t_equation,
  pn_ana_h_t.trimmed,
  optimizer,
  write="phonetic_models/pn_ana_h_t"
)
charts$intercepts
charts$slopes


```



### Analysis of H F0

- Only intercepts only model avoided convergence and singularity issues
```{r set h_f0 equation}
h_f0_equation = formula(
  h_f0 ~ ana_syls + acc_phon
  + (1 | speaker)
  )

optimizer = "optimx"
```

- model needs trimming (residuals +/- 2.6 s.d.)
```{r run h_f0 models, fig.height=3, fig.width=9}
pn_ana_h_f0_mdl = lmer(
  h_f0_equation,
  pn_ana_h,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
pn_ana_h_f0.trimmed <- pn_ana_h %>% filter(abs(scale(resid(pn_ana_h_f0_mdl))) <= 3)

pn_ana_h_f0_mdl.trimmed = lmer(
  h_f0_equation,
  pn_ana_h_f0.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(pn_ana_h_f0_mdl.trimmed, run_step = TRUE, write = "anovas/pn_ana_h_f0.csv")
allFit(pn_ana_h_f0_mdl.trimmed)
```


```{r h_f0 model summary, fig.height=3.5, fig.width=7, results="asis"}

pn_ana_h_f0_mdl.trimmed.tidy <- analyseModel(pn_ana_h_f0_mdl.trimmed,
                                write="phonetic_models/pn_ana_h_f0",
                                type = "pred"
                                )
pn_ana_h_f0_mdl.trimmed.tidy$table

```

```{r do h_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  h_f0_equation,
  pn_ana_h_f0.trimmed,
  optimizer,
  write="phonetic_models/pn_ana_h_f0"
)
charts$intercepts
charts$slopes


```


## L targets

```{r l Get data}
# Get  data for analysis. NB: there are only L*H here!
l_star_type <-  c("L*H")

pn_ana_l <- pn_ana %>%
  select(speaker,
         gender,
         ana_syls,
         acc_phon,
         l_t,
         l_f0,
         lh_dur,
         foot_dur,
         speech_rate) %>%
  filter(acc_phon %in% l_star_type) %>%
  mutate(acc_phon = factor(acc_phon, levels = l_star_type))

```

### Analysis of L timing

- Only intercepts only model avoided convergence and singularity issues
- speech rate caused errors!
```{r set l_t equation}
l_t_equation = formula(
  l_t ~ ana_syls + gender
  + (1 | speaker)
 # + (1 | speech_rate)
  )

optimizer = "optimx"
```

- model needs trimming (residuals +/- 3 s.d.)
```{r run l_t models, fig.height=3, fig.width=9}
pn_ana_l_t_mdl = lmer(
  l_t_equation,
  pn_ana_l,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
pn_ana_l_t.trimmed <- pn_ana_l %>% filter(abs(scale(resid(pn_ana_l_t_mdl))) <= 3)

pn_ana_l_t_mdl.trimmed = lmer(
  l_t_equation,
  pn_ana_l_t.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

allFit(pn_ana_l_t_mdl.trimmed)

summariseLME(pn_ana_l_t_mdl.trimmed, run_step = TRUE, write = "anovas/pn_ana_l_t.csv")
```


```{r l_t model summary, fig.height=3.5, fig.width=7, results="asis"}

pn_ana_l_t_mdl.trimmed.tidy <- analyseModel(pn_ana_l_t_mdl.trimmed,
                                write="phonetic_models/pn_ana_l_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )
pn_ana_l_t_mdl.trimmed.tidy$table

```

```{r do l_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  l_t_equation,
  pn_ana_l_t.trimmed,
  optimizer,
  write="phonetic_models/pn_ana_l_t"
)
charts$intercepts
charts$slopes


```



### Analysis of L F0

- Only intercepts only model avoided convergence and singularity issues
- Speech rate caused massive estimation issues
```{r set l_f0 equation}
l_f0_equation = formula(
  l_f0 ~ ana_syls
  + (1 | speaker)
  )

optimizer = "optimx"
```

```{r run l_f0 models, fig.height=3, fig.width=9}
pn_ana_l_f0_mdl = lmer(
  l_f0_equation,
  pn_ana_l,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
pn_ana_l_f0.trimmed <-
  pn_ana_l %>% filter(abs(scale(resid(pn_ana_l_f0_mdl))) <= 4)


pn_ana_l_f0_mdl.trimmed = lmer(
  l_f0_equation,
  pn_ana_l_f0.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(pn_ana_l_f0_mdl.trimmed, run_step = FALSE, write = "anovas/pn_ana_l_f0.csv")
allFit(pn_ana_l_f0_mdl.trimmed)
```


```{r l_f0 model summary, fig.height=3.5, fig.width=7, results="asis"}

pn_ana_l_f0_mdl.tidy <- analyseModel(pn_ana_l_f0_mdl,
                                write="phonetic_models/pn_ana_l_f0",
                                type = "pred"
                                )
pn_ana_l_f0_mdl.tidy$table

```

```{r do l_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  l_f0_equation,
  pn_ana_l,
  optimizer,
  write="phonetic_models/pn_ana_l_f0"
)
charts$intercepts
charts$slopes


```


