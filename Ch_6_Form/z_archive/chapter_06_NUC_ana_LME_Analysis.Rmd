---
title: "LME Analysis of anacrusis NUCs"
author: "Antoin Rodgers"
date: "18.05.2022"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# Get personal functions and install / load necessary packages.
source("../functions/myFunctions.R")

installMissingPackages(
  c(
    # Include statistical packages.
    "performance",
    "lmerTest",
    "lme4",
    "ggeffects",
    "optimx",
    "MuMIn",

    # Include packages for tidy output.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",
    
    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)



# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 14))
```

## H targets

```{r h Get data}
# Get  data for analysis

source("6_0_get_AH.R")

#rm(pn, nuc_foot, pn_lex, pn_ana, corpus, nuc)

nuc_pre_h <- nuc_pre %>%
  select(
    speaker,
    gender,
    pre_syls,
    fin_phon,
    h_t,
    h_f0,
    lh_dur,
    foot_dur,
    speech_rate
  )

```

### Analysis of H timing

- Only intercepts only model avoided convergence and singularity issues
- Random factors reduce 
```{r set h_t equation}
h_t_equation = formula(
  h_t ~ pre_syls + fin_phon + gender
  + (1 | speaker)
  + (1 | speech_rate)
  )


optimizer = "optimx"
```

- model needs trimming (residuals +/- 2.5 s.d.)
```{r run h_t models, fig.height=3, fig.width=9}
nuc_pre_h_t_mdl = lmer(
  h_t_equation,
  nuc_pre_h,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_pre_h_t.trimmed <-
  nuc_pre_h %>% filter(abs(scale(resid(nuc_pre_h_t_mdl))) <= 2.5)

nuc_pre_h_t_mdl.trimmed = lmer(
  h_t_equation,
  nuc_pre_h_t.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(nuc_pre_h_t_mdl.trimmed, run_step = TRUE, write = "anovas/nuc_pre_h_t.csv")
```


```{r h_t model summary, fig.height=3.5, fig.width=7, results="asis"}

nuc_pre_h_t_mdl.tidy <- analyseModel(nuc_pre_h_t_mdl.trimmed,
                                write="phonetic_models/nuc_pre_h_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )
nuc_pre_h_t_mdl.tidy$table

```

```{r do h_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  h_t_equation,
  nuc_pre_h,
  optimizer,
  write="phonetic_models/nuc_pre_h_t"
)
charts$intercepts
charts$slopes


```



### Analysis of H F0

- Only intercepts only model avoided convergence and singularity issues
- speech rate and foot_dur est p=1 !!! by step
```{r set h_f0 equation}
h_f0_equation = formula(
  h_f0 ~ pre_syls + fin_phon
  + (1 | speaker)
  + (1 | speech_rate)
  + (1 | foot_dur)
  )


optimizer = "optimx"
```

- model needs trimming (residuals +/- 3.5 s.d.)
```{r run h_f0 models, fig.height=3, fig.width=9}
nuc_pre_h_f0_mdl = lmer(
  h_f0_equation,
  nuc_pre_h,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_pre_h_f0.trimmed <-
  nuc_pre_h %>% filter(abs(scale(resid(nuc_pre_h_f0_mdl))) <= 3.5)

nuc_pre_h_f0_mdl.trimmed = lmer(
  h_f0_equation,
  nuc_pre_h_f0.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(nuc_pre_h_f0_mdl.trimmed, run_step = TRUE, write = "anovas/nuc_pre_h_f0.csv")
```


```{r h_f0 model summary, fig.height=3.5, fig.width=7, results="asis"}

nuc_pre_h_f0_mdl.trimmed.tidy <- analyseModel(nuc_pre_h_f0_mdl.trimmed,
                                write="phonetic_models/nuc_pre_h_f0",
                                type = "pred"
                                )
nuc_pre_h_f0_mdl.trimmed.tidy$table

```

```{r do h_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  h_f0_equation,
  nuc_pre_h_f0.trimmed,
  optimizer,
  write="phonetic_models/nuc_pre_h_f0"
)
charts$intercepts
charts$slopes


```


## L targets

```{r l Get data}
# Get  data for analysis
l_star_type <-  c("L*H", "L*")
source("6_0_get_AH.R")

rm(pn_foot, nuc_pre, pn_lex, pn_ana, pn, corpus, nuc)

nuc_pre_l <- nuc_pre %>%
  select(speaker,
         gender,
         pre_syls,
         acc_phon,
         fin_phon,
         l_t,
         l_f0,
         lh_dur,
         foot_dur,
         speech_rate) %>%
  filter(acc_phon %in% l_star_type) %>%
  mutate(acc_phon = factor(acc_phon, levels = l_star_type))

```

### Analysis of L timing

- Only intercepts only model avoided convergence and singularity issues
- 
```{r set l_t equation}
l_t_equation = formula(
  l_t ~  pre_syls
  + fin_phon
  + gender
  + (1 | speaker)
  + (1 | speech_rate)
  + (1 | foot_dur)
  )

optimizer = "optimx"
```

```{r run l_t models, fig.height=3, fig.width=9}
nuc_pre_l_t_mdl = lmer(
  l_t_equation,
  nuc_pre_l,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

allFit(nuc_pre_l_t_mdl)

summariseLME(nuc_pre_l_t_mdl, run_step = TRUE, write = "anovas/nuc_pre_l_t.csv")
```


```{r l_t model summary, fig.height=3.5, fig.width=7, results="asis"}

nuc_pre_l_t_mdl.tidy <- analyseModel(nuc_pre_l_t_mdl,
                                write="phonetic_models/nuc_pre_l_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )
nuc_pre_l_t_mdl.tidy$table

```

```{r do l_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  l_t_equation,
  nuc_pre_l,
  optimizer,
  write="phonetic_models/nuc_pre_l_t"
)
charts$intercepts
charts$slopes


```



### Analysis of L F0

- Only intercepts only model avoided convergence and singularity issues
- Speech rate caused massive estimation issues
```{r set l_f0 equation}
l_f0_equation = formula(
  l_f0 ~ pre_syls
  + fin_phon
  + (1 | speaker)
  + (1 | speech_rate)
  + (1 | foot_dur)
  )

optimizer = "optimx"
```

- model needs trimming
```{r run l_f0 models, fig.height=3, fig.width=9}
nuc_pre_l_f0_mdl = lmer(
  l_f0_equation,
  nuc_pre_l,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_pre_l_f0.trimmed <-
  nuc_pre_l %>% filter(abs(scale(resid(nuc_pre_l_f0_mdl))) <= 3)


nuc_pre_l_f0_mdl.trimmed = lmer(
  l_f0_equation,
  nuc_pre_l_f0.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)


summariseLME(nuc_pre_l_f0_mdl.trimmed,
             run_step = TRUE,
             write = "anovas/nuc_pre_l_f0.csv")
allFit(nuc_pre_l_f0_mdl.trimmed)
```


```{r l_f0 model summary, fig.height=3.5, fig.width=7, results="asis"}

nuc_pre_l_f0_mdl.tidy <- analyseModel(nuc_pre_l_f0_mdl.trimmed,
                                write="phonetic_models/nuc_pre_l_f0",
                                type = "pred"
                                )
nuc_pre_l_f0_mdl.tidy$table

```

```{r do l_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  l_f0_equation,
  nuc_pre_l_f0.trimmed,
  optimizer,
  write="phonetic_models/nuc_pre_l_f0"
)
charts$intercepts
charts$slopes


```


