---
title: "LME Analysis of PNs"
author: "Antoin Rodgers"
date: "18.05.2022"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# Get personal functions and install / load necessary packages.
source("../functions/myFunctions.R")

installMissingPackages(
  c(
    # Include statistical packages.
    "performance",
    "lmerTest",
    "lme4",
    "ggeffects",
    "optimx",
    "MuMIn",
    "dfoptim",

    # Include packages for tidy output.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",
    
    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)



# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 14))

# Get  data for analysis

source("get_AH_corpora.R")

h_star_type <-  c("H*", ">H*", "L*H")
l_star_type <-  c("L*", "L*H")

pn <- pn %>%
  select(speaker,
         gender,
         ana_syls,
         foot_syls,
         wrd_end_syl,
         ana_text,
         ana_ends_word,
         acc_phon,
         speech_rate,
         ana_end_t,
         foot_dur,
         l_t,
         l_f0,
         h_t,
         h_f0) %>%
  mutate(
    foot_dur = foot_dur / 100,
    gender = factor(gender, levels = c("F", "M")),
    foot_syls = factor(foot_syls, levels = 1:4)
  )

pn_l_data <- pn %>% 
  filter(acc_phon %in% l_star_type) %>% 
  mutate(acc_phon = factor(acc_phon, levels = l_star_type)) %>% 
  select(-c(h_t, h_f0))
  
pn_h_data <- pn %>% 
  filter(acc_phon %in% h_star_type) %>% 
  mutate(acc_phon = factor(acc_phon, levels = h_star_type)) %>% 
  select(-c(l_t, l_f0))

rm(pn, nuc, nuc_foot, pn_lex, pn_ana, pn_foot, corpus, nuc_pre)


```

```{r check levels in factors, results="asis", eval=FALSE}

cat("Tibble factors for pn_l_data\n")
for (i in colnames(pn_l_data))
{
  if (is.factor(pn_l_data[[eval(i)]]))
  {
    cat("\n", i, "  \tlevels = ", levels(pn_l_data[[i]]))
  }
  else
  {
    cat("\n", i)
    }
  
}

cat("\n\nTibble factors for pn_h_data\n")
for (i in colnames(pn_h_data))
{
  if (is.factor(pn_h_data[[eval(i)]]))
  {
    cat("\n", i, "  \tlevels = ", levels(pn_h_data[[i]]))
  }
    else
  {
    cat("\n", i)
    }
  
}


```

## H targets

### Analysis of H timing

- Only intercepts only model avoided convergence and singularity issues
- Random factors reduce 
```{r set h_t equation}
h_t_equation = formula(
  h_t ~ acc_phon
  + ana_syls
  + foot_syls
  + wrd_end_syl
  + gender
  + (1 | speaker)
 #+ (1 | speech_rate)
 #+ (1 | ana_end_t)
  + (1 | ana_text)
  + (1 | foot_dur)
  )


optimizer = "optimx"
```

- model needs trimming (residuals +/- 3 s.d.)
```{r run h_t models, fig.height=3, fig.width=9}
pn_h_t_mdl = lmer(
  h_t_equation,
  pn_h_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
pn_h_t.trimmed <-
  pn_h_data %>% filter(abs(scale(resid(pn_h_t_mdl))) <= 3)

pn_h_t_mdl.trimmed = lmer(
  h_t_equation,
  pn_h_t.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)
summariseLME(pn_h_t_mdl.trimmed, run_step = TRUE, write = "anovas/pn_h_t.csv")
```


```{r h_t model symmary, fig.height=2.5, fig.width=5, results="asis"}
tidyPrediction(pn_h_t_mdl.trimmed, write = "predictions/pn_h_t_mdl")

pn_h_t_mdl.tidy <- analyseModel(pn_h_t_mdl.trimmed,
                                write="phonetic_models/pn_h_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )
pn_h_t_mdl.tidy$table

```

```{r do h_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  h_t_equation,
  pn_h_t.trimmed,
  optimizer,
  write="phonetic_models/pn_h_t"
)
charts$intercepts
charts$slopes


```

### Analysis of H F0

- model dosn't work with SR, ana_end_t, or foot_dur (and suggested to be removed by step())
```{r set h_f0 equation}
h_f0_equation = formula(
  h_f0 ~ acc_phon
  + ana_syls
  + foot_syls
  + wrd_end_syl
  + (1 | speaker)
  + (1 | ana_text)
  #+ (1 | speech_rate)
  #+ (1 | ana_end_t)
  #+ (1 | foot_dur)
  )

optimizer = "optimx"
```

```{r run h_f0 models, fig.height=3, fig.width=9}
pn_h_f0_mdl = lmer(
  h_f0_equation,
  pn_h_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)


summariseLME(pn_h_f0_mdl,
             run_step = TRUE,
             write = "anovas/pn_h_f0.csv")
```


```{r h_f0 model symmary, fig.height=2.5, fig.width=5, results="asis"}
tidyPrediction(pn_h_f0_mdl, write = "predictions/pn_h_f0_mdl")
pn_h_f0_mdl.tidy <- analyseModel(pn_h_f0_mdl,
                                write="phonetic_models/pn_h_f0",
                                type = "pred"
                                )
pn_h_f0_mdl.tidy$table

```

```{r do h_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  h_f0_equation,
  pn_h_data,
  optimizer,
  write="phonetic_models/pn_h_f0"
)
charts$intercepts
charts$slopes


```


## L targets

### Analysis of L timing
- removing SR and foot_dur for parity with h_t model (and also singularity)
```{r set l_t equation}
l_t_equation = formula(
  l_t ~ acc_phon
  + ana_syls
  + foot_syls
  + wrd_end_syl
  + gender
  + (1 | speaker)
  #+ (1 | speech_rate)
  + (1 | ana_text)
  + (1 | ana_end_t)
  #+ (1 | foot_dur)
  )

optimizer = "optimx"
```

- intercepts only model
- trim: +/- residual sd > 3
```{r run l_t models, fig.height=3, fig.width=9}
pn_l_t_mdl = lmer(
  l_t_equation,
  pn_l_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
pn_l_t.trimmed <-
  pn_l_data %>% filter(abs(scale(resid(pn_l_t_mdl))) <= 2.5)

pn_l_t_mdl.trimmed = lmer(
  l_t_equation,
  pn_l_t.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

summariseLME(pn_l_t_mdl.trimmed, run_step = TRUE, write = "anovas/pn_l_t.csv")
```


```{r l_t model symmary, fig.height=2.5, fig.width=5, results="asis"}
tidyPrediction(pn_l_t_mdl.trimmed, write = "predictions/pn_l_t_mdl")
pn_l_t_mdl.tidy <- analyseModel(pn_l_t_mdl.trimmed,
                                write="phonetic_models/pn_l_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )
pn_l_t_mdl.tidy$table

```

```{r do l_t pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  l_t_equation,
  pn_l_t.trimmed,
  optimizer,
  write="phonetic_models/pn_l_t"
)
charts$intercepts
charts$slopes


```



### Analysis of L F0

- Only intercepts only model avoided convergence and singularity issues
- Speech rate caused massive estimation issues, removing non speaker random effects due to singularity (as per H F0)

```{r set l_f0 equation}
l_f0_equation = formula(
  l_f0 ~ acc_phon
  + ana_syls
  + foot_syls
  + wrd_end_syl
  + (1 | speaker)
  #+ (1 | speech_rate)
  + (1 | ana_text)
  #+ (1 | ana_end_t)
  #+ (1 | foot_dur)
  )
optimizer = "optimx"
```

- model needs trimming (|sd| residuals > 3.5)
```{r run l_f0 models, fig.height=3, fig.width=9}
pn_l_f0_mdl = lmer(
  l_f0_equation,
  pn_l_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
pn_l_f0.trimmed <-
  pn_l_data %>% filter(abs(scale(resid(pn_l_f0_mdl))) <= 3.5)


pn_l_f0_mdl.trimmed = lmer(
  l_f0_equation,
  pn_l_f0.trimmed,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)


summariseLME(pn_l_f0_mdl.trimmed,
             run_step = TRUE,
             write = "anovas/pn_l_f0.csv")
```


```{r l_f0 model symmary, fig.height=2.5, fig.width=5, results="asis"}
tidyPrediction(pn_l_f0_mdl.trimmed, write = "predictions/pn_l_f0_mdl")
pn_l_f0_mdl.tidy <- analyseModel(pn_l_f0_mdl.trimmed,
                                write="phonetic_models/pn_l_f0",
                                type = "pred"
                                )
pn_l_f0_mdl.tidy$table

```

```{r do l_f0 pairwise analysis, fig.height=2.5, fig.width=5}

charts <- getModelFixedFX(
  l_f0_equation,
  pn_l_f0.trimmed,
  optimizer,
  write="phonetic_models/pn_l_f0"
)
charts$intercepts
charts$slopes


```


