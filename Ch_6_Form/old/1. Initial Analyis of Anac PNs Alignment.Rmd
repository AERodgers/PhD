---
title: "Analysis of PNs - Overview of Anacrusis Effects on Alignment"
author: "Antoin Rodgers"
date: "1/19/2020"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

```{r setup}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```


Get packages from library.
```{r message=FALSE, warning=FALSE, include=FALSE}
source('drawResiduals.R', echo=TRUE)

require("tidyverse")
require("broom")
require("styler")
require("lmerTest")
require("optimx")
require("sjPlot")
require("sjmisc")
require("ggplot2")
require("hablar")
require("ggpubr")
require("MuMIn")
require("mefa4")

library(tidyverse)
library(broom)
library(styler)
library(lmerTest)
library(optimx)
library(sjPlot)
library(sjmisc)
library(ggplot2)
library(hablar)
library(ggpubr)
library(MuMIn)
require(mefa4)
options(ggplot2.palette="Set2")

theme_set(
    theme_minimal(base_size = 18)
)
```


Create data tbls
```{r message=FALSE, warning=TRUE, include=FALSE}

# Get A_corpus data
A_corpus <- read_csv("../data/a_corpus.csv") %>%
    filter(code %notin% c("F15_A1422_1", "M10_A1422_1", "F5_H0422_2")) %>% # remove surplus reps for balance
    filter(
        cur_foot == 1,
        substr(stim, 2, 4) == metre_ID
        ) %>%
    select(
        speaker, gender, stim,
        init_phon, ana_syls, foot_syls, tot_syls,
        acc_phon, wrd_end_syl,
        ana_end_t, phr_end_t,
        wrd_fin_syl_strt_t, wrd_end_t, ana_end_t,
        foot_strt_t, foot_end_t,
        v_onset_t, l_t, h_t,
        v_sylNormT, l_sylNormT, h_sylNormT,
        l_f0, h_f0, mean_st, slope_st
  ) %>%
    mutate(
        d_f0 = h_f0 - l_f0,
        d_t = h_t - l_t,
        l_t = l_t - v_onset_t,
        h_t = h_t - v_onset_t,
        l_tNorm = l_sylNormT - v_sylNormT,
        h_tNorm = h_sylNormT - v_sylNormT,
        foot_dur_t = foot_end_t - foot_strt_t,
        SR = 1000 * tot_syls / phr_end_t,
        isLH = acc_phon %in% "L*H",#
        isDHorLH = acc_phon %in% c("L*H", ">H*"),
        stim = factor(stim,levels = unique(stim))
        ) %>%
    rename(ana_dur = ana_end_t) %>%
    select(-c("phr_end_t", "tot_syls", "v_onset_t")) %>%
    convert(fct(speaker:wrd_end_syl))


# Get ANAC subset
pn_anac <- filter(A_corpus, stim %in% c("H0422", "A1422", "A2422", "A3422"))
pn_anac_distrib <- select(pn_anac, ana_syls, gender, acc_phon) %>%
  group_by(ana_syls, acc_phon, gender) %>%
  summarise(accCount = n()) %>%
  spread(acc_phon, accCount) %>%
  replace(., is.na(.), 0)
  
# get SR data
# get speech rate (SR) data.
SR_meansData <- full_join(
    select(a_frag <- A_corpus %>%
               filter(acc_phon %in% c("L*H", "H*", ">H*", "L*", "(*)")) %>%
               mutate(isLH = acc_phon %in% "L*H") %>%
               select(speaker,
                      gender,
                      acc_phon,
                      ana_syls,
                      foot_syls,
                      ana_dur,
                      SR,
                      isLH
                      ) %>%
               group_by(speaker, gender),
           speaker, gender, acc_phon, foot_syls, ana_dur, SR,isLH
           ) %>%
        group_by(speaker, acc_phon) %>%
        summarise(accCount = n()) %>%
        spread(acc_phon, accCount) %>%
        replace(., is.na(.), 0) %>%
        rename(
            "LH" = "L*H", "dH" = ">H*", "H" = "H*", "L" = "L*", "none" = "(*)"
            ) %>% 
        mutate(
            totalAccs = sum(LH, dH, H, L, none),
            LH_pc = LH / totalAccs,
            H_pc = (H) / totalAccs
            ),
    select(a_frag, speaker, SR) %>%
        group_by(speaker, gender) %>%
        summarise(meanSpRate = mean(SR)),
    by = "speaker")
    rm(a_frag)
    
    
write_tsv(
    pn_anac %>% group_by(acc_phon, ana_syls) %>%
    summarise(accCount = n()) %>%
    spread(acc_phon, accCount, is.na <-(0)),
    "../output/pn_anac_count_actual.txt"
    ) 

```


# Looking at PN distribution by speaker, gender, and ana_syls 

```{r fig.height=4, fig.width=14}
PNbyGender = ggplot(pn_anac) +
  geom_bar(
    mapping = aes(x = gender, fill = acc_phon),
    position = "fill"
  ) + 
  ggtitle("PN ratios by gender")

PNbyAnaSylsAll = ggplot(pn_anac) +
  geom_bar(
    mapping = aes(x = ana_syls, fill = acc_phon),
    position = "fill"
  ) +
  ggtitle("PN ratios by ana syls")

PNbyAnaSylsGen = ggplot(pn_anac) +
  geom_bar(
    mapping = aes(x = ana_syls, fill = acc_phon),
    position = "fill"
  ) + 
  facet_wrap(~gender) +
  ggtitle("PN ratios by gender and ana syls")

ggarrange(PNbyGender, PNbyAnaSylsAll, PNbyAnaSylsGen, ncol = 3,
          common.legend = TRUE, legend = "right")

ggplot(pn_anac) +
  geom_bar(
    mapping = aes(x = speaker, fill = acc_phon),
    position = "fill"
  ) + 
  ggtitle("PN ratios by speaker") 

ggplot(pn_anac) +  facet_wrap(~speaker) +
  geom_bar(
    mapping = aes(x = ana_syls, fill = acc_phon),
    position = "fill"
  ) + 
  ggtitle("PN ratios by speaker") 

```

1. Suggests that gender is a strong factor in PA distribution.
2. Might suggest that >H* for women ~= H* for men and...
3. ... >H* for men ~= L*H for women!
4. i.e., on average, women delay H* while men are more likely to delete L of L\*H, thus realising L\*H as >H\*
5. This idea is very compelling, but I really don't know what to do with it!!!
6. The overall trend for the affect of ana_syls on PN is not very strong
    a. ana_syls = 1 appears to be the only condition which shows a difference overall (lack of) trend, possibly because of the syntactic sentence structure. This is shown below, where the | indicates a foot break, and  [] the syntactic NP in question:
        - [The valley] | 's by the | river
        - There was | [a valley with a | river]
    b. For the female speakers, >H* disappears altogether when ana_syls condition exceeds 1
7. Note: ana0 is missing for two of the male speakers! However, the overall trend appears to hold across speakers that the females are more likely to use L\*H than the men, and that occurrences of L\*H increase with ana_syls. especially if we take into consideration the off >H* hypothesis (below)


### Rejigging >H* by gender
1. This appears to solve the distibution by gender issue.
2. It creates strange distribution patterm of odd H\* across anacrusis conditions.
3. This could still be an arefact of phonological labelling.

```{r fig.height=4, fig.width=12}
pn_anac <- mutate(pn_anac, LH_odd = (
    gender == "M" & (acc_phon == ">H*" | acc_phon == "L*H") |
        gender == "F" & (acc_phon == "L*H" | acc_phon == "L*")))

LH_odd <- select(pn_anac, ana_syls, speaker, acc_phon, gender, LH_odd)

PN_LH_odd_byGender = ggplot(LH_odd) +
  geom_bar(
    mapping = aes(x = gender, fill = LH_odd),
    position = "fill"
  ) + 
  ggtitle(expression(paste(bold("gendered >H*: "), "PN ratios by gender", sep = "")))

PN_LH_odd_byAnaSyls = ggplot(LH_odd) +
  geom_bar(
    mapping = aes(x = ana_syls, fill = LH_odd),
    position = "fill"
  ) + 
  ggtitle(expression(paste(bold("odd L*H "), "PN ratios by ana syls", sep = "")))


ggarrange(PN_LH_odd_byGender, PN_LH_odd_byAnaSyls,ncol = 2,
          common.legend = TRUE, legend = "right")

ggplot(LH_odd) +
  geom_bar(
    mapping = aes(x = speaker, fill = LH_odd),
    position = "fill"
  ) + 
  ggtitle("PN ratios by speaker") 

ggplot(LH_odd) +  facet_wrap(~speaker) +
  geom_bar(
    mapping = aes(x = ana_syls, fill = LH_odd),
    position = "fill"
  ) + 
  ggtitle("PN ratios by speaker") 

```

#### Conclusion re distibution by gender
There may simply not be a large enough sample to make judgements about gender effects here!

# Visual analysis of L and H tonal alignment
### Looking at average timing of H by PA and gender in pn_anac

A. This suggests that overall

  1. The absence or presence of anacrusis has a noticeable effect on the timeing of H targets.
  2. In H\* / >H\* conditions, additional syllables of anacrusis does not have a noticeable effect.
  3. For males, as ana_syls increases, so too does the IQR.
  4. In L*H, the addition of futher syllables of anacrusis causes H to rift rightwards.

B. Possible causes

  1. Time pressure. Lack of anacrusis provides speak with less time to realise targets in best manner.
  2. H\* / >H\* targets are attached the stressed syllable, so one best timing is achieved, no need to drift further to right.
  3. This could be an artefact of labelling, and even with the three-way split between L\*H, >H\*, it is difficult to distinguish between the >H* and L* of male speakers. It could also be that for some of the male speakers there actually is little quantatiive difference in the realisation of these two categories.
  4. It is assumed that the H of L\*H is a attached to or associated with a point typically beyond the stressed syllable: the final syllable of the word, a fixed point in the foot, a fixed point after the L\*. Therefore, one would expect that, as anacrusis size increases, the speaker is able to realise L* more comfortably (i.e. slightly later as there is more preceding 'space'), and so the timing of the H should also be realised later.

C. Implications

  1. Tests should be run on datasets with a +/- anacrusis factor to see if presence/absence of anacrusis truly is significant;
  2. Tests (including pairwise tests) should be run on a subset were ana_syls > 0 to see if there is any significant systematic effect of additional anacrusis;
  3. It might be necessary to provide a test of the increase in variance across anacrusis conditions of male speakers as a function of syllables in anacrusis!
  4. If the L timing hypothesis is right, L\* timing in L\*H should parallel the H data should also indicate rightward drift.
```{r fig.height=4, fig.width=4}
pn_anac %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = acc_phon, y = h_t, colour = acc_phon)) +
  ggtitle("H time by PNs across ana_syls (all)") + 
  labs(x = "anacrusis size by PN pitch accent", y = "Time (ms)") +
  ylim(0, 400)
```
  
```{r fig.height=4, fig.width=14}

allBox = pn_anac %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = acc_phon, y = h_t, colour = ana_syls)) +
  ggtitle("H time by PNs across ana_syls (all)") + 
  labs(x = "anacrusis size by PN pitch accent", y = "Time (ms)") +
  ylim(0, 400)

fBox = pn_anac %>% 
  filter(gender == "F") %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = acc_phon, y = h_t, colour = ana_syls)) +
  ggtitle("H time by PNs across ana_syls (female)") + 
  labs(x = "anacrusis size by PN pitch accent", y = NULL) +
  ylim(0, 400)


mBox = pn_anac %>% 
  filter(gender == "M") %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = acc_phon, y = h_t, colour = ana_syls)) + 
  ggtitle("H time by PNs across ana_syls (male)") + 
  labs(x = "aanacrusis size by PN pitch accent", y = NULL) +
  ylim(0, 400)

ggarrange(allBox, fBox, mBox, ncol = 3, common.legend = TRUE, legend = "bottom")
```

### H time in gendered >H*

```{r fig.height=4, fig.width=4}
pn_anac %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = LH_odd, y = h_t, colour = LH_odd)) +
  ggtitle("H time by PNs across ana_syls (all)") + 
  labs(x = "anacrusis size by PN pitch accent", y = "Time (ms)") +
  ylim(0, 400)
```
```{r fig.height=4, fig.width=14}
allBox = pn_anac %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = LH_odd, y = h_t, colour = ana_syls)) +
  ggtitle("H time by PNs across odd >H* (all)") + 
  labs(x = "ana syl by PN (F=gH*, T=gL*H)", y = "Time (ms)") +
  ylim(0, 400)

fBox = pn_anac %>% 
  filter(gender == "F") %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = LH_odd, y = h_t, colour = ana_syls)) +
  ggtitle("H time by PNs across odd >H* (female)") + 
  labs(x = "aana syl by PN (F=gH*, T=gL*H)", y = "Time (ms)") +
  ylim(0, 400)


mBox = pn_anac %>% 
  filter(gender == "M") %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = LH_odd, y = h_t, colour = ana_syls)) + 
  ggtitle("H time by PNs across odd >H* (male)") + 
  labs(x = "ana syl by PN (F=gH*, T=gL*H)", y = "Time (ms)") +
  ylim(0, 400)

ggarrange(allBox, fBox, mBox, ncol = 3, common.legend = TRUE, legend = "bottom")
```

When the >H\* is split along gendered lines into L\*H and H\* we see a much clearer pattern!
This is very odd, suggesting that:
1. female speakers are more likely to delay peaks of H\* --> >H*
2. male speakers are more likely to delete the L of L\*H --> >H*

### Looking at average timing of L by PA and gender in pn_anac

```{r fig.height=4, fig.width=14}
allBox = pn_anac %>% filter (isLH == TRUE) %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = acc_phon, y = l_t, colour = ana_syls)) +
  ggtitle("L time by PNs across ana_syls (all)") + 
  labs(x = "anacrusis size by PN pitch accent", y = "Time (ms)") +
  ylim(0, 400)

fBox = pn_anac %>% filter (isLH == TRUE) %>% 
  filter(gender == "F") %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = acc_phon, y = l_t, colour = ana_syls)) +
  ggtitle("L time by PNs across ana_syls (female)") + 
  labs(x = "anacrusis size by PN pitch accent", y = NULL) +
  ylim(0, 400)

  
mBox = pn_anac %>% filter (isLH == TRUE) %>% 
  filter(gender == "M") %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = acc_phon, y = l_t, colour = ana_syls)) + 
  ggtitle("H time by PNs across ana_syls (male)") + 
  labs(x = "anacrusis size by PN pitch accent", y = NULL) +
  ylim(0, 400)

ggarrange(allBox, fBox, mBox, ncol = 3, common.legend = TRUE, legend = "bottom")
```

1. The results do not match the expectation.
2. In fact, ana_syls looks like it has a slight leftward drifting effect on the location of L*, which is reversed in ana_syls = 3
3. It seems unlikely this is an artefact of the stimuli. since ana2 and ana3 are structurally very similar. If any artefact effect was to be noted, it should be between ana1 and ana2.
  * ana1 = "The valley's by the river
  * ana2 = "There's a valley with a river"
  * ana3 = "There was a valley with a river"
3. There doesn't appear to be any clear relationship between +/- anacrusis for L_t
4. There doesn't appear to be any clear effect of number of syls of anacrusis
5. It is possible that the varied results are an artefact of the alignment measuring technique itself. This will be addressed in a later chapter.
6. There does appear to be a significant effect of gender on L time.


### H time independent of PN type

```{r}
pn_anac %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = ana_syls, y = h_t, colour = ana_syls)) +
  ggtitle("H timing by syllables of anacrusis (all)") + 
  labs(x = "Syllables", y = "Time (ms)") +
  ylim(0, 400)
```

This overall timing of H by syllables of anacrusis reflects the general trend previously observed. Do note, however, the very large tails of ana_syls = 1

# Looking at Speech Rate (SR = syls / sec) effects
Initial analysis suggested that there was an potential interaction of gender and speech rate in the realisation of PN pitch accents. Therefore, I decided to look into this

### Visual analysis of Speech Rate, Gender, and PAs (from a_corpus)
1. indicates a negative correlation between speech rate and L\*H realisation and between speechrate and H\* / >H\* realisation.
2. NB, it is possible that speakers adjust speech rate depending on the type of PA they wish to achieve, so, tempting as it it, it is difficult to categorise this as a causal link!
3. There appears to be an effect of gender based on the box plot.
4. The scatter diagrams suggest that speakers could be caterrogised as slow (F12, F15, F15) and fast speakers (everyone else!) Suggests creating a Fast/Slow factor to test accents.
```{r echo=FALSE, fig.height=4, fig.width=14}
## plot graphs
plot1 <- ggplot(SR_meansData) +
  geom_text(mapping = aes(
    x = meanSpRate, y = LH_pc,
    col = gender, label = speaker
  )) +
  geom_smooth(method = "lm", mapping = aes(x = meanSpRate, y = LH_pc)) +
  ggtitle("L*H ~ mean speech rate in PN anacrusis data") +
  labs(x = "speech rate (syls/sec)", y = "% occurrence of L*H")

plot2 <- ggplot(SR_meansData) +
  geom_text(mapping = aes(
    x = meanSpRate, y = H_pc,
    col = gender, label = speaker
  )) +
  geom_smooth(method = "lm", mapping = aes(x = meanSpRate, y = H_pc)) +
  ggtitle("H* ~ mean speech rate in PN anacrusis data") +
  labs(x = "speech rate (syls/sec)", y = "% occurrence of H* and >H*")

plot3 <- ggplot(pn_anac) +
  geom_boxplot(mapping = aes(x = gender, y = SR, col = gender)) +
  ggtitle("SR per utterance by gender (larger subset of A-corpus") +
  labs(x = "Gender", y = "SR / utterance (syls/sec")


ggarrange(plot1, plot2, plot3, ncol = 3, common.legend = TRUE, legend = "right")
```

### Testing average timing of H by PA and speaker SR category in pn_anac
1. Figures show that when we split speaker categories into fast and slow, slow SR never produce H* and >H* only occurs (somewhat strangely) in ana_syls = 1.
2. Absence / presence of anacrusis effect less pronouncd for slow SR
3. Effect of ana_syls size also less evident.
4. FastST figure reflects SR ALL, but with more outliers.
5. This simply reinforced the fact that speechrate affects timing of H targets.
6. Don't think there is any principled reason to use SR_slow as a category over all since the parameter SR already captures this.

```{r echo=FALSE, fig.height=4, fig.width=14}
slowBox = pn_anac %>% 
  mutate(slow = speaker %in% c("F12", "F15", "F16")) %>% 
  filter(slow == "TRUE") %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = acc_phon, y = h_t, colour = ana_syls)) +
  ggtitle("H time by PNs across ana_syls (slow SR)") + 
  labs(x = "anacrusis size by PN pitch accent", y = "Time (ms)") +
  ylim(0, 400)

fastBox = pn_anac %>% 
  mutate(slow = speaker %in% c("F12", "F15", "F16")) %>% 
  filter(slow == "FALSE") %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = acc_phon, y = h_t, colour = ana_syls)) +
  ggtitle("H time by PNs across ana_syls (fast SR)") + 
  labs(x = "anacrusis size by PN pitch accent", y = "Time (ms)") +
  ylim(0, 400)

ggarrange(allBox, slowBox, fastBox, ncol = 3, common.legend = TRUE, legend = "right")

rm("slowBox", "fastBox")
```



### Running linear model tests on SR mean data in terms of L\*H and gender

1. Effect of gender on SR not significant (p. = 0.1). 
2. Effect of SR on LH realisation significant (p. = 0.005).
3. Effect of gender on percentage of LH realisation below significance threshold  (p. <0.05).
4. As expected no sig. interaction of gender and speech rate.
5. Given the difficulty of reaching meaningful conclusions about the effect of gender on PA distribution as a function of anacrusis, it is dubious if the statistically _significant_ result for L\*H is meaningful, especially since the test should be rerun for H\* p.c. (and >H\* p.c.). Taking info account family-wise error rates and using the Bonferroni method, the significance threshold should perhaps be set to p.< 0.025, which would place effect of gender outside the significance threshold. 

```{r echo=FALSE, fig.height=4, fig.width=14}
## run LM tests
SR_by_Gender <- lm(meanSpRate ~ gender, data = SR_meansData)
print(SR_by_Gender$call)
tidy(summary(SR_by_Gender))
LHpc_by_SR_Gender <- lm(LH_pc ~ meanSpRate * gender, data = SR_meansData)
print(LHpc_by_SR_Gender$call)
tidy(anova(LHpc_by_SR_Gender))

```

# Conclusion
Speech rate appears to have a significant effect on the realisation of H targets, which is only sensible since the analysis were being made in terms of time Taking into consideration the overall speech rate of an utterance may well be a good way to maintain further analysis within the actual time domain but compensating for the relative effects of speech rate. (The alternative is to use syllable-normalised or foot-normalised time, which is then one degree further removed from the actual realisation of the tonal targets.)
Despite the dubiousness of gender as a significant effect on PA type, it still appears possible that it looks like it does have an effect on the alignment of H targets in PNs as a function of anacrusis. Therfore, in more sophisticated modelling, it will still be treated as a factor.
