---
title: "LME Analysis of NUCs"
author: "Antoin Rodgers"
date: "18.05.2022"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# Get personal functions and install / load necessary packages.
source("../functions/myFunctions.R")

installMissingPackages(
  c(
    # Include statistical packages.
    "performance",
    "lmerTest",
    "lme4",
    "ggeffects",
    "optimx",
    "MuMIn",
    "dfoptim",

    # Include packages for tidy output.
    "tidyverse",
    "broomExtra",
    "sjPlot",
    "formattable",
    "knitr",
    "janitor",
    
    # Include packages for %in% %notin% syntactic notation
    "mefa4"
  )
)

# Set themes and colour schemes.
theme_set(theme_minimal(base_size = 14))

# Get  data for analysis

source("6_0_get_AH.R")

nuc_data <- nuc %>%
  # there must be a more efficient way of doing this but...
  # Create column of stressed syllables in foot 2.
    select(
    stim,
    speaker,
    gender,
    pre_syls,
    foot_syls,
    nuc_pre_text,
    nuc_new_word,
    nuc_str_syl,
    fin_phon,
    stim,
    h_t,
    h_f0,
    l_t,
    l_f0,
    e_t,
    e_f0,
    f0_exc,
    lh_dur,
    lh_slope,
    foot_dur,
    speech_rate
  )



rm(nuc, pn, pn_ana, pn_foot, nuc_pre, nuc_foot, pn_lex, corpus)

```

```{r check levels in factors, results="asis", eval=FALSE}

star_found = F
cat("\n\nFactors for nuc_data\n")
for (i in colnames(nuc_data)) {
  if(length(unique(nuc_data[[i]])) == 1){
    star = " *"
  star_found = T
  }
  else{
    star = ""
    }

  if (is.factor(nuc_data[[eval(i)]])) {
    cat("\n", i, star, "  \tunique = ", length(unique(nuc_data[[i]])),
        "  \tlevels = ", length(levels(nuc_data[[i]])), sep = "")
  }
    else {
    cat("\n", i, sep = "")
    }
}
cat("\n")
if(star_found){
  cat("\n* Factor only has one level in the actual data.\n")
}

nuc_data %>%
  group_by(pre_syls) %>%
  summarise(count = n()) %>% 
  adorn_totals("row") %>% 
  formattable(caption = "pre_syls stim variety")

nuc_data %>%
  group_by(nuc_new_word) %>%
  summarise(count = n()) %>%
  adorn_totals("row") %>% 
  formattable(caption = "nuc_new_word stim variety")
```

## L targets

### Analysis of L timing

```{r set l_t equation}
l_t_equation = formula(
  l_t ~ foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
  + (1 | nuc_str_syl)
)

optimizer = "optimx"
```


```{r run l_t models, fig.height=3, fig.width=9}
nuc_l_t_mdl = lmer(
  l_t_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_l_t_data.trimmed <- nuc_data %>% filter(abs(scale(resid(nuc_l_t_mdl))) <= 3)
nuc_l_t_mdl.trimmed = update(nuc_l_t_mdl, data = nuc_l_t_data.trimmed)
 anova <- summariseLME(nuc_l_t_mdl.trimmed,
             run_step = F,
             write = "6_5_nuc_all_output/nuc_l_t_anova.csv")
 
 adjustP_posthoc("6_5_nuc_all_output/",
                 p.value,
                 suffix_id = "_anova")
 
 read_csv("6_5_nuc_all_output/nuc_l_t_anova.csv") %>%
   tidyStatNumbers() %>%
   formattable(caption = paste("ANOVA of model:",
                               getModelFormula(nuc_l_t_mdl.trimmed)))
```

```{r l_t model summary, fig.height=2.5, fig.width = 3.01, results="asis"}
plot_model(nuc_l_t_mdl, type = "re",
           caption = "Random effects of stressed syllable")

nuc_l_t_mdl.tidy <- analyseModel(nuc_l_t_mdl,
                                write="6_5_nuc_all_output/nuc_l_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )

```

```{r do l_t pairwise analysis, fig.height=2.5, fig.width = 3.01}

charts <- getModelFixedFX(
  nuc_l_t_mdl,
  write="6_5_nuc_all_output/nuc_l_t"
)
charts$intercepts
charts$slopes
```

### Analysis of L F0

```{r set l_f0 equation}
l_f0_equation = formula(
  l_f0 ~
    foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
  + (1 | nuc_str_syl)
)
optimizer = "optimx"
```

```{r run l_f0 models, fig.height=3, fig.width=9}
nuc_l_f0_mdl = lmer(
  l_f0_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_l_f0.trimmed <-
  nuc_data %>% filter(abs(scale(resid(nuc_l_f0_mdl))) <= 2.5)

nuc_l_f0_mdl.trimmed = update(nuc_l_f0_mdl, data = nuc_l_f0.trimmed)

anova <- summariseLME(nuc_l_f0_mdl.trimmed,
                      run_step = F,
                      write = "6_5_nuc_all_output/nuc_l_f0_anova.csv")

adjustP_posthoc("6_5_nuc_all_output/",
                p.value,
                suffix_id = "_anova")

read_csv("6_5_nuc_all_output/nuc_l_f0_anova.csv") %>%
  tidyStatNumbers() %>%
  formattable(caption = paste("ANOVA of model:",
                              getModelFormula(nuc_l_f0_mdl.trimmed)))
```

```{r l_f0 model summary, fig.height=2.5, fig.width = 3.01, results="asis"}
nuc_l_f0_mdl.tidy <- analyseModel(nuc_l_f0_mdl.trimmed,
                                write="6_5_nuc_all_output/nuc_l_f0",
                                type = "pred"
                                )

```

```{r do l_f0 pairwise analysis, fig.height=2.5, fig.width = 3.01}

charts <- getModelFixedFX(
  nuc_l_f0_mdl.trimmed,
  write="6_5_nuc_all_output/nuc_l_f0"
)
charts$intercepts
charts$slopes


```

## H targets

### Analysis of H timing

```{r set h_t equation}
h_t_equation = formula(
  h_t ~
    foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
  + (1 | nuc_str_syl)
)

optimizer = "optimx"
```

```{r run h_t models, fig.height=3, fig.width=9}
nuc_h_t_mdl = lmer(
  h_t_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_h_t_mdl = update(nuc_h_t_mdl,
                     data = nuc_data %>%
                       filter(abs(scale(resid(nuc_h_t_mdl))) <= 3))

anova <- summariseLME(nuc_h_t_mdl,
                      run_step = F,
                      write = "6_5_nuc_all_output/nuc_h_t_anova.csv")

adjustP_posthoc("6_5_nuc_all_output/",
                p.value,
                suffix_id = "_anova")

read_csv("6_5_nuc_all_output/nuc_h_t_anova.csv") %>%
  tidyStatNumbers() %>%
  formattable(caption = paste("ANOVA of model:",
                              getModelFormula(nuc_h_t_mdl)))
```


```{r h_t model summary, fig.height=2.5, fig.width = 3.01, results="asis"}
nuc_h_t_mdl.tidy <- analyseModel(nuc_h_t_mdl,
                                write="6_5_nuc_all_output/nuc_h_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )

```

```{r do h_t pairwise analysis, fig.height=2.5, fig.width = 3.01}

charts <- getModelFixedFX(
  nuc_h_t_mdl,
  write="6_5_nuc_all_output/nuc_h_t"
)
charts$intercepts
charts$slopes
```

### Analysis of H F0

```{r set h_f0 equation}
h_f0_equation = formula(
  h_f0 ~ 
    foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
  + (1 | nuc_str_syl)
)

optimizer = "optimx"
```

```{r run h_f0 models, fig.height=3, fig.width=9}
nuc_h_f0_mdl = lmer(
  h_f0_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_h_f0_mdl.trimmed = update(nuc_h_f0_mdl,
                              data = nuc_data %>%
                                filter(abs(scale(resid(nuc_h_f0_mdl))) <= 4))

anova <- summariseLME(nuc_h_f0_mdl.trimmed,
                      run_step = F,
                      write = "6_5_nuc_all_output/nuc_h_f0_anova.csv")

adjustP_posthoc("6_5_nuc_all_output/",
                p.value,
                suffix_id = "_anova")

read_csv("6_5_nuc_all_output/nuc_h_f0_anova.csv") %>%
  tidyStatNumbers() %>%
  formattable(caption = paste("ANOVA of model:",
                              getModelFormula(nuc_h_f0_mdl.trimmed)))
```

```{r h_f0 model summary, fig.height=2.5, fig.width = 3.01, results="asis"}
nuc_h_f0_mdl.tidy <- analyseModel(nuc_h_f0_mdl.trimmed,
                                write="6_5_nuc_all_output/nuc_h_f0",
                                type = "pred"
                                )

```

```{r do h_f0 pairwise analysis, fig.height=2.5, fig.width = 3.01}

charts <- getModelFixedFX(
  nuc_h_f0_mdl.trimmed,
  write="6_5_nuc_all_output/nuc_h_f0"
)
charts$intercepts
charts$slopes

```

## E targets

```{r set e_t equation}
### Analysis of E timing
# E timing is not of interest as it is just the last f0 time point in the IP!

e_t_equation = formula(
  e_t ~ 
    foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
  + (1 | nuc_str_syl)
)

optimizer = "optimx"
```

```{r run e_t models, fig.height=3, fig.width=9, include = F}
nuc_e_t_mdl = lmer(
  e_t_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_e_t_mdl.trimmed = update(nuc_e_t_mdl,
                             data = nuc_data %>%
                               filter(abs(scale(resid(nuc_e_t_mdl))) <= 4)
)

x <- summariseLME(nuc_e_t_mdl.trimmed,
             run_step = F)
```

```{r e_t model summary, fig.height=2.5, fig.width = 3.01, include = F, results="asis"}
nuc_e_t_mdl.tidy <- analyseModel(nuc_e_t_mdl.trimmed,
                                write="6_5_nuc_all_output/nuc_e_t",
                                type = "pred",
                                factor_matrix = TRUE
                                )

```

```{r do e_t pairwise analysis, fig.height=2.5, fig.width = 3.01, include=F}
charts <- getModelFixedFX(
  nuc_e_t_mdl.trimmed,
  write="6_5_nuc_all_output/nuc_e_t"
)
```

### Analysis of E F0

```{r set e_f0 equation}
e_f0_equation = formula(
  e_f0 ~ 
    foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
  + (1 | nuc_str_syl)
)

optimizer = "optimx"
```

- model needs trimming (|sd| residuals > 3.5)
```{r run e_f0 models, fig.height=3, fig.width=9}
nuc_e_f0_mdl = lmer(
  e_f0_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_e_f0_mdl.trimmed = update(
  nuc_e_f0_mdl,
  data = nuc_data %>% filter(abs(scale(resid(nuc_e_f0_mdl))) <= 3.5))

 anova <- summariseLME(nuc_e_f0_mdl.trimmed,
             run_step = F,
             write = "6_5_nuc_all_output/nuc_e_f0_anova.csv")
 
 adjustP_posthoc("6_5_nuc_all_output/",
                 p.value,
                 suffix_id = "_anova")
 
 read_csv("6_5_nuc_all_output/nuc_e_f0_anova.csv") %>%
   tidyStatNumbers() %>%
   formattable(caption = paste("ANOVA of model:",
                               getModelFormula(nuc_e_f0_mdl.trimmed)))
```


```{r e_f0 model summary, fig.height=2.5, fig.width = 3.01, results="asis"}
nuc_e_f0_mdl.tidy <- analyseModel(nuc_e_f0_mdl,
                                write="6_5_nuc_all_output/nuc_e_f0",
                                type = "pred"
                                )

```

```{r do e_f0 pairwise analysis, fig.height=2.5, fig.width = 3.01}

charts <- getModelFixedFX(
  nuc_e_f0_mdl.trimmed,
  write="6_5_nuc_all_output/nuc_e_f0"
)
charts$intercepts
charts$slopes
```


## Truncation and Compression Effects

### LH Excursion

```{r set f0_exc equation}

f0_exc_equation = formula(
 f0_exc ~ 
    foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
  + (1 | nuc_str_syl)
)

optimizer = "optimx"
```

- model needs trimming (|sd| residuals > 2.5)
```{r run f0_exc models, fig.height=3, fig.width=9}
nuc_f0_exc_mdl = lmer(
  f0_exc_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_f0_exc.trimmed <-
  nuc_data %>% filter(abs(scale(resid(nuc_f0_exc_mdl))) <= 2.5)

nuc_f0_exc_mdl.trimmed = update(
  nuc_f0_exc_mdl,
  data = nuc_data %>% filter(abs(scale(resid(nuc_f0_exc_mdl))) <= 2.5)
  )

anova <- summariseLME(nuc_f0_exc_mdl.trimmed,
             run_step = F,
             write = "6_5_nuc_all_output/nuc_f0_exc_anova.csv")

 adjustP_posthoc("6_5_nuc_all_output/",
                 p.value,
                 suffix_id = "_anova")
 
 read_csv("6_5_nuc_all_output/nuc_f0_exc_anova.csv") %>%
   tidyStatNumbers() %>%
   formattable(caption = paste("ANOVA of model:",
                               getModelFormula(nuc_f0_exc_mdl.trimmed)))
```

```{r f0_exc model summary, fig.height=2.5, fig.width = 3.01, results="asis"}

nuc_f0_exc_mdl.tidy <- analyseModel(nuc_f0_exc_mdl.trimmed,
                                write="6_5_nuc_all_output/nuc_f0_exc",
                                type = "pred"
                                )

```

```{r do f0_exc pairwise analysis, fig.height=2.5, fig.width = 3.01}

charts <- getModelFixedFX(
  nuc_f0_exc_mdl.trimmed,
  write="6_5_nuc_all_output/nuc_f0_exc"
)
charts$intercepts
charts$slopes


```


### LH Slope

Based on results from tonal target analysis, it looksl like compression and truncation may be in effect.
As compression leads to decrease in duration of rise (but not necessarily much descrease in excursion size), and as slope increases exponentially as duration decreases, slope has been logged here.

- model works once random intercepts of speech_rate and foot_dur removed
```{r set lh_slope equation}
nuc_data <- nuc_data %>% 
    mutate(log_lh_slope = log(lh_slope))

lh_slope_equation = formula(
  log_lh_slope ~
    foot_syls
  + pre_syls
  + fin_phon
  + nuc_new_word
  + gender
  + (1 | speaker)
  + (1 | nuc_str_syl)
)
optimizer = "optimx"
```

- model needs trimming (|sd| residuals > 3.5)
```{r run lh_slope models, fig.height=3, fig.width=9}
nuc_lh_slope_mdl = lmer(
  lh_slope_equation,
  nuc_data,
  control = lmerControl(
    optimizer = optimizer,
    calc.derivs = FALSE,
    optCtrl = list(
      method = "nlminb",
      starttests = FALSE,
      kkt = FALSE
    )
  )
)

# model needs trimming
nuc_lh_slope_mdl.trimmed = update(
  nuc_lh_slope_mdl,
  data = nuc_data %>% filter(abs(scale(resid(nuc_lh_slope_mdl))) <= 3)
)

 anova <- summariseLME(nuc_lh_slope_mdl.trimmed,
             run_step = F,
             write = "6_5_nuc_all_output/nuc_lh_slope_anova.csv")
 
 
 adjustP_posthoc("6_5_nuc_all_output/",
                 p.value,
                 suffix_id = "_anova")
 
 read_csv("6_5_nuc_all_output/nuc_lh_slope_anova.csv") %>%
   tidyStatNumbers() %>%
   formattable(caption = paste("ANOVA of model:",
                               getModelFormula(nuc_lh_slope_mdl.trimmed)))
```

```{r lh_slope model summary, fig.height=2.5, fig.width = 3.01, results="asis"}
nuc_lh_slope_mdl.tidy <- analyseModel(nuc_lh_slope_mdl.trimmed,
                                write="6_5_nuc_all_output/nuc_lh_slope",
                                type = "pred"
                                )
```

```{r do lh_slope pairwise analysis, fig.height=2.5, fig.width = 3.01}

charts <- getModelFixedFX(
  nuc_lh_slope_mdl.trimmed,
  write="6_5_nuc_all_output/nuc_lh_slope"
)
charts$intercepts
charts$slopes


```
